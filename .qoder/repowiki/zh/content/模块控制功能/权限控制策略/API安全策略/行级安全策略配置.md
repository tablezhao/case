# 行级安全策略配置

<cite>
**本文档引用文件**  
- [00008_create_module_settings.sql](file://supabase/migrations/00008_create_module_settings.sql)
- [00014_create_site_settings_table.sql](file://supabase/migrations/00014_create_site_settings_table.sql)
- [00018_create_navigation_order_table.sql](file://supabase/migrations/00018_create_navigation_order_table.sql)
- [api.ts](file://src/db/api.ts)
- [types.ts](file://src/types/types.ts)
- [SiteSettingsPage.tsx](file://src/pages/admin/SiteSettingsPage.tsx)
- [NavigationOrderPage.tsx](file://src/pages/admin/NavigationOrderPage.tsx)
</cite>

## 目录
1. [引言](#引言)
2. [核心配置表结构](#核心配置表结构)
3. [行级安全策略配置](#行级安全策略配置)
4. [策略启用与验证流程](#策略启用与验证流程)
5. [前端API调用权限校验机制](#前端api调用权限校验机制)
6. [总结](#总结)

## 引言
本文档详细说明了在合规通系统中为`navigation_order`、`module_settings`和`site_settings`三个关键配置表设置行级安全（RLS）策略的实现方案。通过基于角色的访问控制机制，确保只有`admin`角色的用户才能对这些配置表执行INSERT、UPDATE和DELETE操作，从而保障系统配置的安全性和稳定性。

## 核心配置表结构
系统中的三个核心配置表分别用于管理导航排序、模块设置和站点基本信息。这些表的结构设计如下：

### navigation_order 表
该表用于存储前端导航栏模块的排序配置，支持管理员调整模块显示顺序和控制模块可见性。

**字段说明：**
- `id`：主键，UUID类型，自动生成
- `module_key`：模块标识符，文本类型，唯一且非空
- `module_name`：模块显示名称，文本类型，非空
- `route_path`：路由路径，文本类型，非空
- `sort_order`：排序序号，整数类型，非空
- `is_visible`：是否可见，布尔类型，默认为true
- `created_at`：创建时间，时间戳类型，自动生成
- `updated_at`：更新时间，时间戳类型，自动更新

### module_settings 表
该表用于控制前台功能模块的可见性，存储模块的启用状态和显示顺序。

**字段说明：**
- `id`：主键，UUID类型，自动生成
- `module_key`：模块唯一标识符，文本类型，唯一且非空
- `module_name`：模块显示名称，文本类型，非空
- `is_enabled`：模块是否启用，布尔类型，默认为true
- `display_order`：显示顺序，整数类型，默认为0
- `description`：模块功能描述，文本类型
- `updated_at`：最后更新时间，时间戳类型，自动更新

### site_settings 表
该表用于集中管理网站的基本信息，包括主标题、备用名称和Logo等。

**字段说明：**
- `id`：主键，UUID类型，自动生成
- `site_title`：网站主标题，文本类型，必填，最大200字符
- `site_subtitle`：网站备用名称/简称，文本类型，可选，最大100字符
- `logo_url`：Logo图片URL，文本类型，可选
- `created_at`：创建时间，时间戳类型，自动生成
- `updated_at`：更新时间，时间戳类型，自动更新

**Section sources**
- [00008_create_module_settings.sql](file://supabase/migrations/00008_create_module_settings.sql#L30-L78)
- [00014_create_site_settings_table.sql](file://supabase/migrations/00014_create_site_settings_table.sql#L40-L48)
- [00018_create_navigation_order_table.sql](file://supabase/migrations/00018_create_navigation_order_table.sql#L30-L39)

## 行级安全策略配置
系统通过PostgreSQL的行级安全（RLS）功能为关键配置表实现了基于角色的访问控制。以下是各表的具体策略配置。

### navigation_order 表的RLS策略
`navigation_order`表启用了行级安全，实现了读写权限的分离：

```sql
-- 启用行级安全
ALTER TABLE navigation_order ENABLE ROW LEVEL SECURITY;

-- 所有人可以读取导航配置
CREATE POLICY "Anyone can view navigation order" ON navigation_order
  FOR SELECT USING (true);

-- 仅管理员可以修改导航配置
CREATE POLICY "Admins can manage navigation order" ON navigation_order
  FOR ALL TO authenticated
  USING (is_admin(auth.uid()))
  WITH CHECK (is_admin(auth.uid()));
```

该策略确保所有用户都可以读取导航配置以正确显示前端导航栏，但只有通过身份验证且具有管理员角色的用户才能执行INSERT、UPDATE和DELETE操作。

### site_settings 表的RLS策略
`site_settings`表同样启用了行级安全，实现了细粒度的权限控制：

```sql
-- 启用行级安全
ALTER TABLE site_settings ENABLE ROW LEVEL SECURITY;

-- 所有用户可读取配置（用于前台展示）
CREATE POLICY "Anyone can view site settings"
  ON site_settings FOR SELECT
  USING (true);

-- 仅管理员可插入配置
CREATE POLICY "Only admins can insert site settings"
  ON site_settings FOR INSERT
  TO authenticated
  WITH CHECK (is_admin(auth.uid()));

-- 仅管理员可更新配置
CREATE POLICY "Only admins can update site settings"
  ON site_settings FOR UPDATE
  TO authenticated
  USING (is_admin(auth.uid()))
  WITH CHECK (is_admin(auth.uid()));

-- 仅管理员可删除配置
CREATE POLICY "Only admins can delete site settings"
  ON site_settings FOR DELETE
  TO authenticated
  USING (is_admin(auth.uid()));
```

该策略允许所有用户读取站点设置以正确渲染页面，但严格限制了写操作，确保只有管理员能够修改站点的基本信息。

### module_settings 表的特殊处理
与前两个表不同，`module_settings`表未启用行级安全策略。根据系统设计，该表的配置信息是公开的，需要被所有用户读取以确定前台模块的显示状态。

```sql
-- 未启用RLS，因为这是公开的配置信息
-- 允许所有用户读取模块设置（前台需要）
```

这种设计决策基于业务需求：模块的启用状态和显示顺序是系统的基础配置，需要被前端应用无限制地访问。

**Diagram sources**
- [00018_create_navigation_order_table.sql](file://supabase/migrations/00018_create_navigation_order_table.sql#L45-L56)
- [00014_create_site_settings_table.sql](file://supabase/migrations/00014_create_site_settings_table.sql#L53-L78)

**Section sources**
- [00018_create_navigation_order_table.sql](file://supabase/migrations/00018_create_navigation_order_table.sql#L45-L56)
- [00014_create_site_settings_table.sql](file://supabase/migrations/00014_create_site_settings_table.sql#L53-L78)
- [00008_create_module_settings.sql](file://supabase/migrations/00008_create_module_settings.sql#L14-L16)

## 策略启用与验证流程
行级安全策略的启用和验证遵循严格的流程，确保配置的正确性和安全性。

### 策略启用流程
1. **创建表结构**：首先使用`CREATE TABLE`语句定义表结构
2. **启用RLS**：使用`ALTER TABLE ... ENABLE ROW LEVEL SECURITY`语句启用行级安全
3. **创建策略**：使用`CREATE POLICY`语句定义具体的访问策略
4. **设置触发器**：为需要自动更新的字段（如`updated_at`）创建触发器

### 权限判断实现
系统使用`is_admin(auth.uid())`函数进行权限判断，该函数通过查询用户资料表来确定用户角色：

```sql
-- 在策略中使用is_admin函数判断权限
WITH CHECK (is_admin(auth.uid()))
```

`is_admin`函数会查询`profiles`表，检查指定用户ID的角色是否为`admin`。这种设计将权限判断逻辑集中管理，提高了安全性和可维护性。

### 策略验证方法
为确保RLS策略正确生效，系统提供了多种验证方法：

1. **数据库查询验证**：直接在数据库中执行查询，验证不同角色的访问权限
2. **API调用测试**：通过前端API调用，测试不同用户角色的操作权限
3. **管理界面验证**：通过管理员后台界面，验证配置修改功能的可用性

### 存储桶访问策略
除了数据库表的RLS策略，系统还为Logo存储桶设置了相应的访问控制：

```sql
-- 所有人可读Logo
CREATE POLICY "Anyone can view logos"
  ON storage.objects FOR SELECT
  USING (bucket_id = 'app-800go8thhcsh_logos');

-- 仅管理员可上传、更新、删除Logo
CREATE POLICY "Only admins can upload logos" ON storage.objects FOR INSERT
  TO authenticated WITH CHECK (bucket_id = 'app-800go8thhcsh_logos' AND is_admin(auth.uid()));
```

这些策略确保了静态资源的安全访问，防止未授权用户修改网站Logo。

**Section sources**
- [00018_create_navigation_order_table.sql](file://supabase/migrations/00018_create_navigation_order_table.sql#L68-L82)
- [00014_create_site_settings_table.sql](file://supabase/migrations/00014_create_site_settings_table.sql#L89-L102)
- [00023_fix_logo_bucket_creation.sql](file://supabase/migrations/00023_fix_logo_bucket_creation.sql#L47-L76)

## 前端API调用权限校验机制
系统的前端通过API调用与后端进行交互，所有涉及配置修改的操作都经过严格的权限校验。

### API函数实现
前端通过`api.ts`文件中的函数与后端进行通信，这些函数封装了具体的数据库操作：

```typescript
// 获取导航排序配置
export async function getNavigationOrder(): Promise<NavigationOrder[]> {
  const { data, error } = await supabase
    .from('navigation_order')
    .select('*')
    .order('sort_order', { ascending: true });
  
  if (error) throw error;
  return data;
}

// 更新导航排序配置
export async function updateNavigationOrder(updates: Array<{ id: string; sort_order: number; is_visible: boolean }>): Promise<void> {
  const promises = updates.map(update =>
    supabase
      .from('navigation_order')
      .update(update)
      .eq('id', update.id)
  );
  
  const results = await Promise.all(promises);
  const errors = results.filter(r => r.error);
  
  if (errors.length > 0) {
    throw new Error('更新导航排序失败');
  }
}
```

### 管理界面权限控制
管理员通过专门的管理界面来修改系统配置，这些界面实现了细粒度的权限控制：

#### 导航排序管理界面
`NavigationOrderPage.tsx`实现了导航排序的管理功能，只有管理员可以访问和修改：

```typescript
// 处理可见性变更
const handleVisibilityChange = async (id: string, checked: boolean) => {
  try {
    await updateNavigationVisibility(id, checked);
    // 更新本地状态
    setEditedModules(prev => /* 更新逻辑 */);
    toast.success('可见性更新成功');
  } catch (error) {
    console.error('更新可见性失败:', error);
    toast.error('更新可见性失败');
  }
};
```

#### 站点设置管理界面
`SiteSettingsPage.tsx`实现了站点基本信息的管理功能，提供了Logo上传和URL输入两种模式：

```typescript
// 处理Logo文件选择
const handleFileSelect = (e: React.ChangeEvent<HTMLInputElement>) => {
  const file = e.target.files?.[0];
  if (!file) return;

  // 验证文件类型和大小
  const allowedTypes = ['image/png', 'image/jpeg', 'image/svg+xml'];
  if (!allowedTypes.includes(file.type)) {
    toast.error('文件格式不支持');
    return;
  }

  // 验证文件大小（2MB）
  const maxSize = 2 * 1024 * 1024;
  if (file.size > maxSize) {
    toast.error('文件过大');
    return;
  }

  setLogoFile(file);
  // 生成预览
  const reader = new FileReader();
  reader.onloadend = () => {
    setLogoPreview(reader.result as string);
  };
  reader.readAsDataURL(file);
};
```

### 权限校验流程
前端API调用的权限校验流程如下：

1. **用户身份验证**：用户登录后，系统会验证其身份并获取角色信息
2. **请求发送**：前端通过Supabase客户端发送数据库操作请求
3. **服务器端校验**：Supabase服务器根据RLS策略校验用户权限
4. **结果返回**：根据校验结果返回数据或错误信息
5. **前端处理**：前端根据返回结果更新UI或显示错误提示

这种分层的权限校验机制确保了系统的安全性，即使前端代码被篡改，服务器端的RLS策略仍然能够阻止未授权的操作。

**Section sources**
- [api.ts](file://src/db/api.ts#L2766-L2826)
- [SiteSettingsPage.tsx](file://src/pages/admin/SiteSettingsPage.tsx#L79-L234)
- [NavigationOrderPage.tsx](file://src/pages/admin/NavigationOrderPage.tsx#L40-L90)

## 总结
本文档详细介绍了合规通系统中`navigation_order`、`module_settings`和`site_settings`三个关键配置表的行级安全策略配置方案。通过启用RLS并设置基于角色的访问控制，系统确保了只有`admin`角色的用户才能修改关键配置，有效保障了系统的安全性和稳定性。

核心要点总结：
- `navigation_order`和`site_settings`表启用了RLS，实现了读写分离的权限控制
- `module_settings`表未启用RLS，因为其配置信息需要被所有用户读取
- 所有写操作都通过`is_admin(auth.uid())`函数进行权限校验
- 前端管理界面通过API调用与后端交互，所有操作都经过服务器端的RLS策略校验
- 系统还为Logo存储桶设置了相应的访问控制策略

这些安全措施共同构成了系统的权限管理体系，为系统的稳定运行提供了有力保障。