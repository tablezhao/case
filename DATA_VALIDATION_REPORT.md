# 数据校验与分析报告

## 一、问题总结

根据数据库实际查询结果，发现以下问题：

### 问题1：数据展示逻辑正确，但用户理解有偏差

**实际数据（2025年12月）**：
- 总记录数：81条
- 唯一应用数：69个
- 通报频次：1次（1个部门 × 1个日期）

**实际数据（2025年11月）**：
- 总记录数：71条
- 唯一应用数：69个
- 通报频次：1次（1个部门 × 1个日期）

**结论**：
- ✅ **数据展示正确**：本月通报频次=1，本月涉及应用=69
- ✅ **统计口径正确**：通报频次按"部门+日期"去重，一次通报活动涉及69个应用
- ⚠️ **用户理解偏差**：用户可能认为1次通报不应该涉及69个应用

### 问题2：环比显示"-0"的原因

**计算逻辑**：
```
本月通报频次 = 1
上月通报频次 = 1
环比变化 = 1 - 1 = 0
环比百分比 = 0 / 1 * 100% = 0.0%
```

**显示问题**：
- 当前显示：`-0 (0.0%)`
- 预期显示：`0 (0.0%)` 或 `持平`

**原因分析**：
- 前端显示逻辑在处理0值时，可能添加了负号
- 需要修复前端显示逻辑

---

## 二、数据详细分析

### 2.1 12月份数据明细

```sql
-- 12月份只有1次通报活动
部门：国家计算机病毒应急处理中心
日期：2025-12-04
涉及应用：81条记录（69个唯一应用，部分应用有重复记录）
```

**数据特点**：
- 单次通报活动涉及大量应用（69个）
- 部分应用有重复记录（如Whatscolors有2条记录）
- 符合实际监管场景：一次集中通报多个违规应用

### 2.2 11月份数据明细

```sql
-- 11月份只有1次通报活动
部门：（另一个部门，ID不同）
日期：2025-11-26
涉及应用：71条记录（69个唯一应用）
```

**数据特点**：
- 同样是单次通报活动
- 涉及69个唯一应用（与12月相同）
- 总记录数71条

### 2.3 累计数据统计

```sql
全部数据：
- 总记录数：182条
- 唯一应用数：168个
- 通报频次：5次
```

**数据验证**：
- ✅ 182条记录 = 81（12月）+ 71（11月）+ 30（其他月份）
- ✅ 168个唯一应用 > 69个（单月应用数）
- ✅ 5次通报频次 = 5个不同的"部门+日期"组合

---

## 三、统计口径说明

### 3.1 通报频次定义

**定义**：按"部门+日期"去重后的数量

**计算逻辑**：
```typescript
const frequency = new Set(
  cases.map(c => `${c.department_id}_${c.report_date}`)
).size;
```

**实际含义**：
- 1次通报频次 = 1个部门在1个日期发布的通报活动
- 1次通报活动可以涉及多个应用

**示例**：
```
2025-12-04，国家计算机病毒应急处理中心发布通报，涉及69个应用
→ 通报频次 = 1
→ 涉及应用 = 69
```

### 3.2 涉及应用数定义

**定义**：去重后的唯一应用名称数量

**计算逻辑**：
```typescript
const apps = new Set(cases.map(c => c.app_name)).size;
```

**实际含义**：
- 统计期内被通报过的不同应用的数量
- 同一个应用在多个平台被通报，只计算1次

### 3.3 数据关系

```
通报频次 ≤ 涉及应用数 ≤ 总记录数

示例：
- 通报频次：1次
- 涉及应用：69个
- 总记录数：81条（部分应用有多条记录）
```

---

## 四、问题根源分析

### 4.1 问题1：数据不一致？

**结论**：❌ 不存在数据不一致问题

**分析**：
1. **通报频次=1，涉及应用=69** 是合理的
2. 符合实际监管场景：一次集中通报多个违规应用
3. 数据库查询结果验证了这一点

**建议**：
- 在界面上添加说明文字，解释统计口径
- 例如："通报频次指通报活动的次数，一次通报可涉及多个应用"

### 4.2 问题2：环比显示"-0"

**结论**：✅ 存在前端显示问题

**分析**：
1. 计算结果正确：0 (0.0%)
2. 显示错误：-0 (0.0%)
3. 原因：前端在处理0值时添加了负号

**需要修复的地方**：
- 前端显示逻辑
- 当变化值为0时，不应显示负号

---

## 五、数据验证结果

### 5.1 月度数据验证

| 指标 | 12月实际值 | 11月实际值 | 环比变化 | 验证结果 |
|------|-----------|-----------|---------|---------|
| 通报频次 | 1 | 1 | 0 | ✅ 正确 |
| 涉及应用 | 69 | 69 | 0 | ✅ 正确 |
| 总记录数 | 81 | 71 | +10 | ✅ 正确 |

### 5.2 累计数据验证

| 指标 | 实际值 | 验证结果 |
|------|--------|---------|
| 累计通报频次 | 5次 | ✅ 正确 |
| 累计涉及应用 | 168个 | ✅ 正确 |
| 累计总记录数 | 182条 | ✅ 正确 |

### 5.3 数据逻辑验证

| 验证项 | 结果 |
|--------|------|
| 时间范围一致性 | ✅ 正确 |
| 去重逻辑正确性 | ✅ 正确 |
| 统计口径一致性 | ✅ 正确 |
| 数据来源一致性 | ✅ 正确 |

---

## 六、需要修复的问题

### 6.1 前端显示问题

**问题**：环比变化显示"-0"

**位置**：`src/pages/HomePage.tsx`

**修复方案**：
```typescript
// 修复前
const displayChange = change;

// 修复后
const displayChange = change === 0 ? 0 : change; // 确保0不显示为-0
// 或者
const displayChange = Math.abs(change) < 0.01 ? 0 : change;
```

**显示优化**：
```typescript
// 当变化为0时，显示"持平"
{change === 0 ? (
  <span className="text-muted-foreground">持平</span>
) : (
  <span className={change > 0 ? 'text-green-600' : 'text-red-600'}>
    {change > 0 ? '+' : ''}{change} ({changePercent.toFixed(1)}%)
  </span>
)}
```

---

## 七、优化建议

### 7.1 界面说明优化

**建议1：添加统计口径说明**

在数据概览卡片下方添加说明：
```
📊 统计说明：
- 通报频次：按"部门+日期"统计的通报活动次数
- 涉及应用：被通报的唯一应用数量（去重）
- 一次通报活动可能涉及多个应用
```

**建议2：添加悬停提示**

```tsx
<Tooltip>
  <TooltipTrigger>
    <span>本月通报频次</span>
    <Info className="w-3 h-3 ml-1" />
  </TooltipTrigger>
  <TooltipContent>
    <p>统计本月内各部门发布的通报活动次数</p>
    <p>按"部门+日期"去重计算</p>
  </TooltipContent>
</Tooltip>
```

### 7.2 数据展示优化

**建议1：添加详细数据展开**

```tsx
<Card>
  <CardHeader>
    <CardTitle>本月通报频次：1次</CardTitle>
  </CardHeader>
  <CardContent>
    <Button variant="ghost" onClick={() => setShowDetail(true)}>
      查看详情
    </Button>
    {showDetail && (
      <div>
        <p>2025-12-04：国家计算机病毒应急处理中心</p>
        <p>涉及应用：69个</p>
      </div>
    )}
  </CardContent>
</Card>
```

**建议2：优化环比显示**

```tsx
// 当变化为0时，显示"持平"而不是"0"
{change === 0 ? (
  <Badge variant="secondary">
    <Minus className="w-3 h-3 mr-1" />
    持平
  </Badge>
) : change > 0 ? (
  <Badge variant="destructive">
    <TrendingUp className="w-3 h-3 mr-1" />
    +{change} ({changePercent.toFixed(1)}%)
  </Badge>
) : (
  <Badge variant="default">
    <TrendingDown className="w-3 h-3 mr-1" />
    {change} ({changePercent.toFixed(1)}%)
  </Badge>
)}
```

### 7.3 数据分析优化

**建议1：添加趋势分析**

```tsx
<Card>
  <CardHeader>
    <CardTitle>通报趋势分析</CardTitle>
  </CardHeader>
  <CardContent>
    <p>本月通报频次与上月持平</p>
    <p>但涉及应用数量保持稳定（69个）</p>
    <p>平均每次通报涉及69个应用</p>
  </CardContent>
</Card>
```

**建议2：添加异常提示**

```tsx
// 当单次通报涉及应用数过多时，添加提示
{appsPerReport > 50 && (
  <Alert>
    <AlertCircle className="w-4 h-4" />
    <AlertTitle>注意</AlertTitle>
    <AlertDescription>
      本月单次通报涉及{appsPerReport}个应用，为集中通报活动
    </AlertDescription>
  </Alert>
)}
```

---

## 八、总结

### 8.1 数据验证结论

✅ **数据统计正确**：
- 通报频次、涉及应用数、累计数据均正确
- 统计口径一致，计算逻辑正确
- 数据来源一致，时间范围准确

❌ **前端显示问题**：
- 环比变化显示"-0"需要修复
- 缺少统计口径说明

### 8.2 核心问题

**问题1：数据不一致？**
- ❌ 不存在数据不一致
- ✅ 数据符合实际监管场景
- 💡 需要添加说明帮助用户理解

**问题2：环比显示"-0"**
- ✅ 确实存在显示问题
- 🔧 需要修复前端显示逻辑
- 💡 建议优化为"持平"显示

### 8.3 后续行动

**立即修复**：
1. 修复环比显示"-0"的问题
2. 添加统计口径说明

**优化建议**：
1. 添加悬停提示
2. 优化环比显示样式
3. 添加详细数据展开
4. 添加趋势分析

---

**报告生成时间**：2025-12-05  
**数据验证范围**：2025年11月-12月  
**验证者**：合规通开发团队
