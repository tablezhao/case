# 调用示例调整方案

## 一、调整前的准备工作

在使用调用示例之前，需要确保已经完成以下两项核心调整：

### 1. 修改 `src/db/api.ts` 中的函数定义

首先需要修改 `getPlatformDistribution` 函数，使其接受并传递 `statDimension` 参数给 RPC 函数：

**修改前**：
```typescript
export async function getPlatformDistribution() {
  const { data, error } = await supabase
    .from('cases')
    .select(`
      platform_id,
      platform:app_platforms(name)
    `);
  
  if (error) throw error;
  
  const platformCounts: Record<string, number> = {};
  (data || []).forEach(item => {
    const plat = item.platform as unknown as { name: string } | null;
    const platformName = plat?.name || '未知平台';
    platformCounts[platformName] = (platformCounts[platformName] || 0) + 1;
  });

  return Object.entries(platformCounts)
    .map(([name, count]) => ({ name, count }))
    .sort((a, b) => b.count - a.count);
}
```

**修改后**：
```typescript
export async function getPlatformDistribution(statDimension: 'case_count' | 'app_count' = 'case_count') {
  try {
    const { data, error } = await supabase.rpc('get_platform_distribution', {
      统计维度: statDimension
    });
    
    if (error) {
      console.error('[getPlatformDistribution] RPC调用失败:', error);
      throw error;
    }
    
    return data || [];
  } catch (error) {
    console.error('[getPlatformDistribution] 获取平台分布数据失败:', error);
    throw error;
  }
}
```

### 2. 在 Supabase 中创建 RPC 函数

需要在 Supabase 控制台中执行以下 SQL 语句，创建 `get_platform_distribution` 函数：

```sql
-- 创建应用平台分布统计函数
CREATE OR REPLACE FUNCTION get_platform_distribution(
  统计维度 TEXT DEFAULT 'case_count'  -- case_count: 案例数量, app_count: 应用数量
)
RETURNS JSON
LANGUAGE plpgsql
AS $$
DECLARE
  result JSON;
BEGIN
  IF 统计维度 = 'app_count' THEN
    -- 按应用数量统计（去重）
    WITH app_platform_stats AS (
      SELECT
        ap.id AS platform_id,
        ap.name AS platform_name,
        COUNT(DISTINCT c.app_name) AS app_count
      FROM cases c
      JOIN app_platforms ap ON c.platform_id = ap.id
      WHERE c.app_name IS NOT NULL
        AND c.app_name != ''
      GROUP BY ap.id, ap.name
    )
    SELECT json_agg(
      json_build_object(
        'name', platform_name,
        'count', app_count
      ) ORDER BY app_count DESC
    ) INTO result
    FROM app_platform_stats;
  ELSE
    -- 默认按案例数量统计
    WITH case_platform_stats AS (
      SELECT
        ap.id AS platform_id,
        ap.name AS platform_name,
        COUNT(*) AS case_count
      FROM cases c
      JOIN app_platforms ap ON c.platform_id = ap.id
      GROUP BY ap.id, ap.name
    )
    SELECT json_agg(
      json_build_object(
        'name', platform_name,
        'count', case_count
      ) ORDER BY case_count DESC
    ) INTO result
    FROM case_platform_stats;
  END IF;
  
  RETURN result;
END;
$$;
```

## 二、调用示例的调整位置

调用示例可以在以下位置使用和调整：

### 1. 在 React 组件中使用

**调整位置**：需要使用平台分布数据的组件文件中，如 `src/components/PlatformDistribution.tsx` 或 `src/pages/HomePage.tsx`

**调整内容**：
```typescript
import { useEffect, useState } from 'react';
import { getPlatformDistribution } from '@/db/api';

function PlatformDistributionComponent() {
  const [platformData, setPlatformData] = useState([]);
  const [loading, setLoading] = useState(true);
  const [statType, setStatType] = useState<'case_count' | 'app_count'>('case_count');

  useEffect(() => {
    const fetchData = async () => {
      try {
        setLoading(true);
        // 调用调整后的函数，传递统计维度参数
        const data = await getPlatformDistribution(statType);
        setPlatformData(data);
      } catch (error) {
        console.error('获取平台分布数据失败:', error);
      } finally {
        setLoading(false);
      }
    };

    fetchData();
  }, [statType]); // 当统计类型变化时重新获取数据

  // 切换统计类型的处理函数
  const handleStatTypeChange = (type: 'case_count' | 'app_count') => {
    setStatType(type);
  };

  return (
    <div>
      <div className="mb-4">
        <button 
          onClick={() => handleStatTypeChange('case_count')}
          className={statType === 'case_count' ? 'active' : ''}
        >
          按案例数量统计
        </button>
        <button 
          onClick={() => handleStatTypeChange('app_count')}
          className={statType === 'app_count' ? 'active' : ''}
        >
          按应用数量统计
        </button>
      </div>
      {/* 平台分布图表或列表展示 */}
      {loading ? (
        <div>加载中...</div>
      ) : (
        <div>
          {platformData.map((item, index) => (
            <div key={index}>
              {item.name}: {item.count}
            </div>
          ))}
        </div>
      )}
    </div>
  );
}
```

### 2. 在数据服务层使用

**调整位置**：`src/services/statistics.ts`（如果有专门的数据服务层文件）

**调整内容**：
```typescript
import { getPlatformDistribution } from '@/db/api';

// 封装平台分布统计服务
export const platformDistributionService = {
  // 获取按案例数量统计的平台分布
  async getByCaseCount() {
    try {
      return await getPlatformDistribution('case_count');
    } catch (error) {
      console.error('获取按案例数量统计的平台分布失败:', error);
      throw error;
    }
  },

  // 获取按应用数量统计的平台分布
  async getByAppCount() {
    try {
      return await getPlatformDistribution('app_count');
    } catch (error) {
      console.error('获取按应用数量统计的平台分布失败:', error);
      throw error;
    }
  },

  // 通用获取方法，接受统计维度参数
  async get(statDimension: 'case_count' | 'app_count') {
    try {
      return await getPlatformDistribution(statDimension);
    } catch (error) {
      console.error('获取平台分布数据失败:', error);
      throw error;
    }
  }
};
```

### 3. 在测试文件中使用

**调整位置**：`src/tests/api.test.ts`（如果有API测试文件）

**调整内容**：
```typescript
import { getPlatformDistribution } from '@/db/api';

describe('Platform Distribution API', () => {
  test('should get platform distribution by case count', async () => {
    const data = await getPlatformDistribution('case_count');
    expect(data).toBeInstanceOf(Array);
    // 其他断言
  });

  test('should get platform distribution by app count', async () => {
    const data = await getPlatformDistribution('app_count');
    expect(data).toBeInstanceOf(Array);
    // 其他断言
  });
});
```

## 三、调整时的注意事项

1. **确保RPC函数已正确创建**：在调整前端代码之前，必须确保Supabase中已成功创建了`get_platform_distribution` RPC函数

2. **类型安全**：使用TypeScript时，确保为函数参数和返回值定义正确的类型

3. **错误处理**：在调用函数时，添加适当的错误处理逻辑，避免因网络错误或RPC调用失败导致应用崩溃

4. **默认值设置**：为函数参数设置合理的默认值，确保函数在未提供参数时仍能正常工作

5. **缓存策略**：考虑添加适当的缓存策略，减少不必要的RPC调用，提高应用性能

6. **加载状态管理**：在组件中使用该函数时，添加加载状态管理，提供良好的用户体验

## 四、调整后的预期效果

调整完成后，调用示例将能够：
1. 根据传递的参数获取不同维度的平台分布数据
2. 支持按案例数量和应用数量两种维度统计
3. 代码更加简洁，性能更高
4. 支持灵活扩展新的统计维度

通过以上调整，您可以在应用中灵活使用这两个调用示例，获取不同维度的平台分布数据，满足各种业务需求。