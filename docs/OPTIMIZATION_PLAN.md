# 统计通报系统优化方案

## 一、需求分析

### 1. 数据展示形式的视觉优化
**问题**：颜色搭配导致辨识度低、难以看清  
**目标**：重新设计配色方案，确保数据对比清晰、视觉层次分明

### 2. 趋势分析的数据口径调整
**关键变更**：核心分析指标从"案例数量"改为"通报应用数量"  
**影响范围**：图表、说明文字、数据逻辑、API接口

### 3. 新增趋势分析维度
**新增内容**："通报频次趋势分析"  
**要求**：独立图表、明确统计口径、与应用数量趋势有机结合

---

## 二、当前系统分析

### 2.1 当前配色方案
```
Light Mode:
- Primary: hsl(213, 65%, 33%) - 深蓝色
- Secondary: hsl(18, 100%, 60%) - 橙色
- Chart-1: hsl(213, 65%, 33%) - 深蓝色
- Chart-2: hsl(18, 100%, 60%) - 橙色
- Chart-3: hsl(173, 58%, 39%) - 青绿色
- Chart-4: hsl(43, 74%, 66%) - 黄色
- Chart-5: hsl(280, 65%, 60%) - 紫色

Dark Mode:
- Primary: hsl(213, 65%, 50%) - 亮蓝色
- Secondary: hsl(18, 100%, 65%) - 亮橙色
- Chart-1: hsl(213, 65%, 50%) - 亮蓝色
- Chart-2: hsl(18, 100%, 65%) - 亮橙色
- Chart-3: hsl(173, 58%, 45%) - 亮青绿色
- Chart-4: hsl(43, 74%, 70%) - 亮黄色
- Chart-5: hsl(280, 65%, 65%) - 亮紫色
```

**问题分析**：
1. ❌ Chart-4（黄色）在浅色背景下辨识度低
2. ❌ 颜色对比度不够，视觉层次不分明
3. ❌ 缺少高对比度的配色方案

### 2.2 当前趋势分析
**数据源**：
- `getMonthlyTrend()` - 按月统计案例数量
- `getYearlyTrend()` - 按年统计案例数量

**统计逻辑**：
```typescript
// 当前：统计所有案例记录数
const monthCounts: Record<string, number> = {};
(data || []).forEach(item => {
  const month = item.report_date.substring(0, 7);
  monthCounts[month] = (monthCounts[month] || 0) + 1;
});
```

**问题**：
- ❌ 统计的是案例记录数，不是应用数量
- ❌ 没有通报频次的趋势分析

---

## 三、优化方案

### 3.1 视觉优化方案

#### 3.1.1 新配色方案设计

**设计原则**：
1. ✅ 高对比度，确保在浅色和深色背景下都清晰可见
2. ✅ 色彩区分明显，避免相近颜色
3. ✅ 符合政府机构的专业形象
4. ✅ 考虑色盲用户的可访问性

**新配色方案**：
```
Light Mode:
- Primary: hsl(213, 78%, 35%) - 政府蓝（加深，提高对比度）
- Secondary: hsl(18, 95%, 55%) - 警示橙（降低亮度，提高可读性）
- Chart-1: hsl(213, 78%, 35%) - 深蓝色（主色调）
- Chart-2: hsl(142, 71%, 35%) - 深绿色（替代青绿色，更清晰）
- Chart-3: hsl(18, 95%, 55%) - 橙色（警示色）
- Chart-4: hsl(280, 65%, 45%) - 深紫色（替代黄色，更清晰）
- Chart-5: hsl(340, 75%, 45%) - 深红色（新增，高对比度）

Dark Mode:
- Primary: hsl(213, 78%, 55%) - 亮蓝色
- Secondary: hsl(18, 95%, 65%) - 亮橙色
- Chart-1: hsl(213, 78%, 55%) - 亮蓝色
- Chart-2: hsl(142, 71%, 55%) - 亮绿色
- Chart-3: hsl(18, 95%, 65%) - 亮橙色
- Chart-4: hsl(280, 65%, 65%) - 亮紫色
- Chart-5: hsl(340, 75%, 65%) - 亮红色
```

**优化效果**：
- ✅ 移除低对比度的黄色
- ✅ 增加深绿色和深红色，提高色彩区分度
- ✅ 调整饱和度和亮度，确保清晰可见
- ✅ 保持政府机构的专业形象

#### 3.1.2 图表视觉优化

**折线图优化**：
- ✅ 增加线条粗细（2px → 3px）
- ✅ 增加数据点大小（4px → 6px）
- ✅ 优化渐变区域的透明度
- ✅ 增加网格线对比度

**饼图优化**：
- ✅ 增加扇区边框（1px白色边框）
- ✅ 优化标签位置和字体大小
- ✅ 增加悬停效果的突出程度

**柱状图优化**：
- ✅ 增加柱子宽度
- ✅ 优化柱子圆角
- ✅ 增加悬停效果

**地图优化**：
- ✅ 增加区域边框对比度
- ✅ 优化颜色渐变范围
- ✅ 增加标签清晰度

#### 3.1.3 数据表格视觉优化

**表格优化**：
- ✅ 增加行间距（提高可读性）
- ✅ 优化斑马纹对比度
- ✅ 增加悬停效果的突出程度
- ✅ 优化表头的视觉权重

### 3.2 数据口径调整方案

#### 3.2.1 API调整

**新增API函数**：
```typescript
// 获取月度应用数量趋势（去重）
export async function getMonthlyAppTrend(year?: string)

// 获取年度应用数量趋势（去重）
export async function getYearlyAppTrend()

// 获取月度通报频次趋势（部门+日期去重）
export async function getMonthlyReportTrend(year?: string)

// 获取年度通报频次趋势（部门+日期去重）
export async function getYearlyReportTrend()
```

**统计逻辑**：
```typescript
// 应用数量趋势：按应用名称去重
const appsByMonth: Record<string, Set<string>> = {};
(data || []).forEach(item => {
  const month = item.report_date.substring(0, 7);
  if (!appsByMonth[month]) appsByMonth[month] = new Set();
  appsByMonth[month].add(item.app_name);
});

// 通报频次趋势：按部门+日期去重
const reportsByMonth: Record<string, Set<string>> = {};
(data || []).forEach(item => {
  const month = item.report_date.substring(0, 7);
  if (!reportsByMonth[month]) reportsByMonth[month] = new Set();
  const key = `${item.department_id}_${item.report_date}`;
  reportsByMonth[month].add(key);
});
```

#### 3.2.2 图表组件调整

**TrendChart组件增强**：
- 支持多系列数据（应用数量 + 通报频次）
- 支持切换显示模式（单独显示 / 对比显示）
- 优化图例和标签

#### 3.2.3 说明文字更新

**更新位置**：
- HomePage中的趋势图标题
- 图表的Tooltip说明
- 数据卡片的描述文字

### 3.3 新增通报频次趋势

#### 3.3.1 UI设计

**布局方案**：
```
┌─────────────────────────────────────────┐
│ 趋势分析                                 │
├─────────────────────────────────────────┤
│ [月度趋势] [年度趋势]                    │
│                                         │
│ 数据维度：[通报应用数量] [通报频次] [对比]│
│                                         │
│ ┌─────────────────────────────────┐   │
│ │                                 │   │
│ │        图表区域                  │   │
│ │                                 │   │
│ └─────────────────────────────────┘   │
│                                         │
│ 📊 统计说明：                           │
│ • 通报应用数量：按应用名称去重统计       │
│ • 通报频次：按部门+日期去重统计         │
└─────────────────────────────────────────┘
```

**交互设计**：
1. 默认显示"通报应用数量"趋势
2. 可切换到"通报频次"趋势
3. 可选择"对比"模式，同时显示两个维度
4. 悬停显示详细数据和说明

#### 3.3.2 组件实现

**新增组件**：
- `TrendComparisonChart.tsx` - 对比图表组件
- `TrendDimensionSelector.tsx` - 维度选择器组件

**增强组件**：
- `TrendChart.tsx` - 支持多系列数据

---

## 四、实施计划

### 阶段一：视觉优化（优先级：高）

**任务清单**：
- [ ] 1.1 更新配色方案（index.css）
- [ ] 1.2 更新图表颜色配置（colors.ts）
- [ ] 1.3 优化TrendChart视觉效果
- [ ] 1.4 优化PieChart视觉效果
- [ ] 1.5 优化GeoChart视觉效果
- [ ] 1.6 优化WordCloud视觉效果
- [ ] 1.7 优化数据表格样式

**预计时间**：2-3小时

### 阶段二：数据口径调整（优先级：高）

**任务清单**：
- [ ] 2.1 新增API函数（应用数量趋势）
- [ ] 2.2 更新HomePage数据获取逻辑
- [ ] 2.3 更新TrendChart数据源
- [ ] 2.4 更新说明文字
- [ ] 2.5 测试数据准确性

**预计时间**：1-2小时

### 阶段三：新增通报频次趋势（优先级：中）

**任务清单**：
- [ ] 3.1 新增API函数（通报频次趋势）
- [ ] 3.2 创建TrendComparisonChart组件
- [ ] 3.3 创建TrendDimensionSelector组件
- [ ] 3.4 集成到HomePage
- [ ] 3.5 添加统计说明
- [ ] 3.6 测试交互功能

**预计时间**：2-3小时

### 阶段四：测试与优化（优先级：中）

**任务清单**：
- [ ] 4.1 视觉效果测试（浅色/深色模式）
- [ ] 4.2 数据准确性测试
- [ ] 4.3 响应式布局测试
- [ ] 4.4 性能测试
- [ ] 4.5 用户体验优化
- [ ] 4.6 代码质量检查

**预计时间**：1-2小时

---

## 五、技术细节

### 5.1 配色方案实现

**文件修改**：
- `src/index.css` - 更新CSS变量
- `src/lib/colors.ts` - 更新图表颜色配置

### 5.2 API实现

**文件修改**：
- `src/db/api.ts` - 新增API函数

**数据库查询**：
```sql
-- 应用数量趋势
SELECT 
  DATE_TRUNC('month', report_date) as month,
  COUNT(DISTINCT app_name) as count
FROM cases
GROUP BY month
ORDER BY month;

-- 通报频次趋势
SELECT 
  DATE_TRUNC('month', report_date) as month,
  COUNT(DISTINCT CONCAT(department_id, '_', report_date)) as count
FROM cases
GROUP BY month
ORDER BY month;
```

### 5.3 组件实现

**文件修改**：
- `src/components/charts/TrendChart.tsx` - 增强功能
- `src/pages/HomePage.tsx` - 集成新功能

**新增文件**：
- `src/components/charts/TrendComparisonChart.tsx`
- `src/components/charts/TrendDimensionSelector.tsx`

---

## 六、预期效果

### 6.1 视觉优化效果

**优化前**：
- ❌ 黄色在浅色背景下难以看清
- ❌ 颜色对比度不够
- ❌ 图表元素过小

**优化后**：
- ✅ 所有颜色在浅色和深色背景下都清晰可见
- ✅ 高对比度配色，视觉层次分明
- ✅ 图表元素大小适中，易于识别

### 6.2 数据口径调整效果

**优化前**：
- ❌ 统计的是案例记录数
- ❌ 无法反映实际应用数量

**优化后**：
- ✅ 统计的是去重后的应用数量
- ✅ 准确反映被通报应用的数量趋势

### 6.3 新增功能效果

**优化前**：
- ❌ 只有应用数量趋势
- ❌ 无法了解通报活动的频率

**优化后**：
- ✅ 同时提供应用数量和通报频次两个维度
- ✅ 可对比分析两个维度的关系
- ✅ 更全面地了解监管动态

---

## 七、风险评估

### 7.1 技术风险

**风险**：API修改可能影响现有功能  
**应对**：保留原有API，新增独立API函数

**风险**：配色修改可能影响整体风格  
**应对**：在测试环境充分测试，确保协调统一

### 7.2 数据风险

**风险**：统计口径变更可能导致数据不一致  
**应对**：明确说明统计口径，添加详细的Tooltip

**风险**：历史数据可能不完整  
**应对**：在图表中标注数据来源和统计说明

### 7.3 用户体验风险

**风险**：新增功能可能增加学习成本  
**应对**：提供清晰的说明和引导

**风险**：配色变更可能影响用户习惯  
**应对**：保持整体风格一致，只优化对比度

---

## 八、成功标准

### 8.1 视觉优化

- ✅ 所有图表颜色在浅色和深色模式下都清晰可见
- ✅ 颜色对比度符合WCAG AA标准
- ✅ 用户反馈视觉效果改善

### 8.2 数据准确性

- ✅ 应用数量趋势统计准确（去重）
- ✅ 通报频次趋势统计准确（部门+日期去重）
- ✅ 数据与数据库查询结果一致

### 8.3 功能完整性

- ✅ 支持切换不同数据维度
- ✅ 支持对比显示
- ✅ 统计说明清晰明确
- ✅ 交互流畅，无bug

### 8.4 代码质量

- ✅ ESLint检查通过
- ✅ TypeScript编译通过
- ✅ 代码结构清晰，易于维护
- ✅ 性能良好，无明显延迟

---

**文档创建时间**：2025-12-05  
**预计完成时间**：2025-12-05  
**负责人**：合规通开发团队
