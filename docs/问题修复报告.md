# æ¡ˆä¾‹æŸ¥è¯¢å¤±è´¥é—®é¢˜ä¿®å¤æŠ¥å‘Š

## ðŸ“‹ é—®é¢˜æ¦‚è¿°

**é—®é¢˜æè¿°**ï¼šè¿›å…¥æ¡ˆä¾‹æŸ¥è¯¢ç•Œé¢æ—¶ï¼Œæç¤º"åŠ è½½æ¡ˆä¾‹å¤±è´¥"

**å‘çŽ°æ—¶é—´**ï¼š2025-12-08

**å½±å“èŒƒå›´**ï¼š
- å‰å°æ¡ˆä¾‹æŸ¥è¯¢é¡µé¢ï¼ˆ/casesï¼‰
- åŽå°æ¡ˆä¾‹ç®¡ç†é¡µé¢ï¼ˆ/admin/casesï¼‰

**ä¸¥é‡ç¨‹åº¦**ï¼šðŸ”´ é«˜ï¼ˆæ ¸å¿ƒåŠŸèƒ½æ— æ³•ä½¿ç”¨ï¼‰

---

## ðŸ” é—®é¢˜åˆ†æž

### æ ¹æœ¬åŽŸå› 

RPCå‡½æ•° `search_cases` ä¸­å­˜åœ¨ä¸¤ä¸ªå­—æ®µåç§°é”™è¯¯ï¼š

1. **å­—æ®µåç§°ä¸åŒ¹é…**
   - å‡½æ•°ä¸­ä½¿ç”¨ï¼š`d.location`
   - å®žé™…è¡¨ç»“æž„ï¼š`d.province`
   - é”™è¯¯ä¿¡æ¯ï¼š`column d.location does not exist`

2. **æ•°æ®ç±»åž‹ä¸åŒ¹é…**
   - å‡½æ•°è¿”å›žç±»åž‹ï¼š`report_date timestamptz`
   - å®žé™…å­—æ®µç±»åž‹ï¼š`report_date date`
   - é”™è¯¯ä¿¡æ¯ï¼š`Returned type date does not match expected type timestamp with time zone`

### é—®é¢˜æ¥æº

åœ¨åˆ›å»ºå…¨æ–‡æœç´¢åŠŸèƒ½æ—¶ï¼Œé”™è¯¯åœ°å‡è®¾äº† `regulatory_departments` è¡¨çš„å­—æ®µåç§°ä¸º `location`ï¼Œä½†å®žé™…è¡¨ç»“æž„ä¸­ä½¿ç”¨çš„æ˜¯ `province`ã€‚

---

## ðŸ”§ ä¿®å¤æ–¹æ¡ˆ

### 1. æ•°æ®åº“å±‚ä¿®å¤

#### 1.1 ä¿®æ­£å­—æ®µåç§°

```sql
-- ä¿®æ”¹å‰
d.location as department_location

-- ä¿®æ”¹åŽ
d.province as department_province
```

#### 1.2 ä¿®æ­£æ•°æ®ç±»åž‹

```sql
-- ä¿®æ”¹å‰
report_date timestamptz

-- ä¿®æ”¹åŽ
report_date date
```

#### 1.3 ä¿®æ­£æ—¥æœŸæ¯”è¾ƒ

```sql
-- ä¿®æ”¹å‰
AND (start_date IS NULL OR c.report_date >= start_date::timestamptz)
AND (end_date IS NULL OR c.report_date <= end_date::timestamptz)

-- ä¿®æ”¹åŽ
AND (start_date IS NULL OR c.report_date >= start_date::date)
AND (end_date IS NULL OR c.report_date <= end_date::date)
```

### 2. APIå±‚ä¿®å¤

ä¿®æ”¹ `src/db/api.ts` ä¸­çš„æ•°æ®è½¬æ¢é€»è¾‘ï¼š

```typescript
// ä¿®æ”¹å‰
department: item.department_name ? {
  id: item.department_id,
  name: item.department_name,
  location: item.department_location,  // âŒ é”™è¯¯
  level: 'national' as const,
  province: '',
  created_at: '',
  updated_at: '',
} : null,

// ä¿®æ”¹åŽ
department: item.department_name ? {
  id: item.department_id,
  name: item.department_name,
  location: item.department_province || '',  // âœ… æ­£ç¡®
  level: 'national' as const,
  province: item.department_province || '',  // âœ… æ­£ç¡®
  created_at: '',
  updated_at: '',
} : null,
```

### 3. è¿ç§»æ–‡ä»¶æ›´æ–°

æ›´æ–° `supabase/migrations/00015_add_fulltext_search.sql`ï¼Œç¡®ä¿ä»¥åŽéƒ¨ç½²æ—¶ä½¿ç”¨æ­£ç¡®çš„å­—æ®µåå’Œç±»åž‹ã€‚

---

## âœ… ä¿®å¤éªŒè¯

### æµ‹è¯•æ­¥éª¤

1. **æ•°æ®åº“å±‚æµ‹è¯•**
   ```sql
   -- æµ‹è¯•RPCå‡½æ•°
   SELECT * FROM search_cases(NULL, 1, 5, NULL, NULL, NULL, NULL) LIMIT 5;
   ```
   
   **é¢„æœŸç»“æžœ**ï¼šâœ… æˆåŠŸè¿”å›ž5æ¡æ¡ˆä¾‹æ•°æ®
   
   **å®žé™…ç»“æžœ**ï¼šâœ… æˆåŠŸè¿”å›žæ•°æ®ï¼ŒåŒ…å«ä»¥ä¸‹å­—æ®µï¼š
   - id, app_name, app_developer
   - department_name, department_province
   - platform_name
   - report_date (dateç±»åž‹)
   - total_count, rank

2. **å‰ç«¯é¡µé¢æµ‹è¯•**
   - è®¿é—® `/cases` é¡µé¢
   - é¢„æœŸç»“æžœï¼šâœ… æˆåŠŸåŠ è½½æ¡ˆä¾‹åˆ—è¡¨
   - å®žé™…ç»“æžœï¼šâœ… é¡µé¢æ­£å¸¸æ˜¾ç¤º

3. **æœç´¢åŠŸèƒ½æµ‹è¯•**
   - è¾“å…¥å…³é”®è¯"å¾®ä¿¡"
   - é¢„æœŸç»“æžœï¼šâœ… è¿”å›žç›¸å…³æ¡ˆä¾‹
   - å®žé™…ç»“æžœï¼šâœ… æœç´¢åŠŸèƒ½æ­£å¸¸

4. **ä»£ç æ£€æŸ¥**
   ```bash
   npm run lint
   ```
   
   **ç»“æžœ**ï¼šâœ… Checked 108 files in 1297ms. No fixes applied.

---

## ðŸ“Š ä¿®å¤æ•ˆæžœ

### ä¿®å¤å‰

| åŠŸèƒ½ | çŠ¶æ€ | è¯´æ˜Ž |
|------|------|------|
| æ¡ˆä¾‹æŸ¥è¯¢é¡µé¢ | âŒ å¤±è´¥ | æç¤º"åŠ è½½æ¡ˆä¾‹å¤±è´¥" |
| æœç´¢åŠŸèƒ½ | âŒ å¤±è´¥ | æ— æ³•æ‰§è¡Œæœç´¢ |
| ç®¡ç†é¡µé¢ | âŒ å¤±è´¥ | æ— æ³•åŠ è½½æ•°æ® |

### ä¿®å¤åŽ

| åŠŸèƒ½ | çŠ¶æ€ | è¯´æ˜Ž |
|------|------|------|
| æ¡ˆä¾‹æŸ¥è¯¢é¡µé¢ | âœ… æ­£å¸¸ | æˆåŠŸåŠ è½½æ¡ˆä¾‹åˆ—è¡¨ |
| æœç´¢åŠŸèƒ½ | âœ… æ­£å¸¸ | æ”¯æŒå…¨æ–‡æœç´¢å’Œæ¨¡ç³ŠåŒ¹é… |
| ç®¡ç†é¡µé¢ | âœ… æ­£å¸¸ | æ•°æ®åŠ è½½å’Œæœç´¢æ­£å¸¸ |

---

## ðŸ“ ä¿®æ”¹æ–‡ä»¶æ¸…å•

### æ•°æ®åº“

1. **ç›´æŽ¥æ‰§è¡ŒSQL**
   - åˆ é™¤æ—§çš„ `search_cases` å‡½æ•°
   - åˆ›å»ºä¿®æ­£åŽçš„ `search_cases` å‡½æ•°

### ä»£ç æ–‡ä»¶

1. **src/db/api.ts**
   - ä¿®æ”¹æ•°æ®è½¬æ¢é€»è¾‘
   - å°† `department_location` æ”¹ä¸º `department_province`

2. **supabase/migrations/00015_add_fulltext_search.sql**
   - é‡æ–°åˆ›å»ºè¿ç§»æ–‡ä»¶
   - ä½¿ç”¨æ­£ç¡®çš„å­—æ®µåå’Œæ•°æ®ç±»åž‹

3. **é—®é¢˜ä¿®å¤æŠ¥å‘Š.md**
   - æ–°å¢žæ–‡æ¡£ï¼ˆæœ¬æ–‡æ¡£ï¼‰

---

## ðŸŽ“ ç»éªŒæ•™è®­

### 1. è¡¨ç»“æž„ç¡®è®¤

åœ¨ç¼–å†™SQLå‡½æ•°å‰ï¼Œå¿…é¡»å…ˆç¡®è®¤è¡¨ç»“æž„ï¼š

```sql
-- æŸ¥çœ‹è¡¨ç»“æž„
SELECT column_name, data_type 
FROM information_schema.columns 
WHERE table_name = 'regulatory_departments';
```

### 2. ç±»åž‹åŒ¹é…

å‡½æ•°è¿”å›žç±»åž‹å¿…é¡»ä¸Žå®žé™…å­—æ®µç±»åž‹å®Œå…¨åŒ¹é…ï¼š

```sql
-- æŸ¥çœ‹å­—æ®µç±»åž‹
SELECT column_name, data_type 
FROM information_schema.columns 
WHERE table_name = 'cases' 
  AND column_name = 'report_date';
```

### 3. æµ‹è¯•å…ˆè¡Œ

åœ¨å‰ç«¯è°ƒç”¨å‰ï¼Œå…ˆåœ¨æ•°æ®åº“å±‚æµ‹è¯•RPCå‡½æ•°ï¼š

```sql
-- æµ‹è¯•å‡½æ•°
SELECT * FROM search_cases(NULL, 1, 5, NULL, NULL, NULL, NULL);
```

### 4. é”™è¯¯ä¿¡æ¯åˆ†æž

PostgreSQLçš„é”™è¯¯ä¿¡æ¯éžå¸¸è¯¦ç»†ï¼Œè¦ä»”ç»†é˜…è¯»ï¼š

```
ERROR: column d.location does not exist
       ^^^^^^^^^^^^^^^^
       æ˜Žç¡®æŒ‡å‡ºäº†ä¸å­˜åœ¨çš„å­—æ®µ
```

---

## ðŸ”„ åŽç»­æ”¹è¿›å»ºè®®

### 1. æ·»åŠ å•å…ƒæµ‹è¯•

ä¸ºRPCå‡½æ•°æ·»åŠ å•å…ƒæµ‹è¯•ï¼Œç¡®ä¿ï¼š
- å‡½æ•°èƒ½æ­£å¸¸æ‰§è¡Œ
- è¿”å›žæ•°æ®æ ¼å¼æ­£ç¡®
- å„ç§å‚æ•°ç»„åˆéƒ½èƒ½æ­£å¸¸å·¥ä½œ

### 2. æ·»åŠ é›†æˆæµ‹è¯•

ä¸ºå‰ç«¯é¡µé¢æ·»åŠ é›†æˆæµ‹è¯•ï¼Œç¡®ä¿ï¼š
- é¡µé¢èƒ½æ­£å¸¸åŠ è½½
- æœç´¢åŠŸèƒ½æ­£å¸¸
- é”™è¯¯å¤„ç†æ­£ç¡®

### 3. æ”¹è¿›é”™è¯¯æç¤º

å‰ç«¯é”™è¯¯æç¤ºåº”è¯¥æ›´å…·ä½“ï¼š

```typescript
// æ”¹è¿›å‰
toast.error('åŠ è½½æ¡ˆä¾‹å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿žæŽ¥');

// æ”¹è¿›åŽ
toast.error(`åŠ è½½æ¡ˆä¾‹å¤±è´¥ï¼š${error.message}`);
```

### 4. æ·»åŠ å¥åº·æ£€æŸ¥

æ·»åŠ APIå¥åº·æ£€æŸ¥ç«¯ç‚¹ï¼Œå®šæœŸæ£€æµ‹ï¼š
- æ•°æ®åº“è¿žæŽ¥
- RPCå‡½æ•°å¯ç”¨æ€§
- å…³é”®è¡¨ç»“æž„å®Œæ•´æ€§

---

## ðŸ“ž æŠ€æœ¯æ”¯æŒ

å¦‚æœ‰ä»»ä½•é—®é¢˜ï¼Œè¯·è”ç³»æŠ€æœ¯å›¢é˜Ÿã€‚

---

## ðŸ“š ç›¸å…³æ–‡æ¡£

1. **å…³é”®è¯æ£€ç´¢ä¼˜åŒ–æŠ€æœ¯æ–¹æ¡ˆ.md** - æœç´¢åŠŸèƒ½æŠ€æœ¯æ–¹æ¡ˆ
2. **æ£€ç´¢åŠŸèƒ½æµ‹è¯•æŒ‡å—.md** - æµ‹è¯•ç”¨ä¾‹å’ŒéªŒæ”¶æ ‡å‡†
3. **æ£€ç´¢åŠŸèƒ½ä¼˜åŒ–å®žæ–½æ€»ç»“.md** - ä¼˜åŒ–å®žæ–½æ€»ç»“
4. **æ£€ç´¢åŠŸèƒ½å¿«é€Ÿå‚è€ƒ.md** - ç”¨æˆ·ä½¿ç”¨æŒ‡å—

---

**æ–‡æ¡£ç‰ˆæœ¬**ï¼šv1.0  
**ä¿®å¤æ—¶é—´**ï¼š2025-12-08  
**ä¿®å¤äººå‘˜**ï¼šæŠ€æœ¯å›¢é˜Ÿ  
**çŠ¶æ€**ï¼šâœ… é—®é¢˜å·²ä¿®å¤å¹¶éªŒè¯
