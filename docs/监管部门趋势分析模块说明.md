# 监管部门趋势分析模块功能说明

## 📅 开发时间
2025-12-10

## ✅ 开发状态
已完成优化并通过代码检查

---

## 🎯 功能概述

在趋势分析页面的通报排名模块下方，新增了**监管部门趋势分析模块**，用于查看单个监管部门的历史通报应用数量变化趋势。

### 核心功能

1. **单部门选择**：使用下拉选择器选择一个监管部门进行分析
2. **部门分级排序**：国家级部门优先显示，省级部门随后
3. **灵活的时间维度**：支持按年统计或查看全部历史数据
4. **响应式布局**：宽屏时图表和表格并排显示，窄屏时表格在图表下方
5. **可视化展示**：通过折线图直观展示部门的应用数量变化趋势
6. **详细数据表格**：提供精确的数值数据，底部显示合计

---

## 🏗️ 技术实现

### 1. 状态管理优化

#### 修改后的状态变量

```typescript
// 趋势分析模块状态管理
const [applicationTrendData, setApplicationTrendData] = useState<any[]>([]);
const [selectedApplicationDataDimension, setSelectedApplicationDataDimension] = useState<TrendDimension>('yearly');
const [selectedTrendYear, setSelectedTrendYear] = useState<string>(new Date().getFullYear().toString());
const [selectedTrendDepartment, setSelectedTrendDepartment] = useState<string>(''); // 改为单选
const [applicationTrendLoading, setApplicationTrendLoading] = useState(false);
const [allDepartments, setAllDepartments] = useState<Department[]>([]);
```

**主要变化**：
- ✅ `selectedTrendDepartments` (数组) → `selectedTrendDepartment` (字符串)
- ✅ 从多选模式改为单选模式
- ✅ 简化了状态管理逻辑

---

### 2. 部门排序逻辑

#### 新增函数：`getSortedDepartments`

```typescript
// 获取排序后的部门列表（国家级在前，省级在后）
const getSortedDepartments = () => {
  const nationalKeywords = ['工业和信息化部', '国家', '中央', '公安部'];
  
  const national = allDepartments.filter(dept => 
    nationalKeywords.some(keyword => dept.name.includes(keyword))
  );
  
  const provincial = allDepartments.filter(dept => 
    !nationalKeywords.some(keyword => dept.name.includes(keyword))
  );
  
  return [...national, ...provincial];
};
```

**排序规则**：
1. **国家级部门**：包含"工业和信息化部"、"国家"、"中央"、"公安部"等关键词
2. **省级部门**：其他所有部门
3. **显示顺序**：国家级部门在前，省级部门在后

**特点**：
- ✅ 自动识别部门级别
- ✅ 清晰的层级结构
- ✅ 便于用户快速找到目标部门

---

### 3. 选择器改进

#### 从 Badge 改为 Select 下拉选择器

**之前的实现**（多选Badge）：
```typescript
<div className="flex flex-wrap gap-2">
  {allDepartments.map(dept => {
    const isSelected = selectedTrendDepartments.includes(dept.id);
    return (
      <Badge
        key={dept.id}
        variant={isSelected ? 'default' : 'outline'}
        className="cursor-pointer hover:opacity-80 transition-opacity"
        onClick={() => toggleDepartmentSelection(dept.id)}
      >
        {dept.name}
      </Badge>
    );
  })}
</div>
```

**现在的实现**（单选Select）：
```typescript
<div className="space-y-2">
  <Label>监管部门</Label>
  <Select
    value={selectedTrendDepartment}
    onValueChange={setSelectedTrendDepartment}
  >
    <SelectTrigger>
      <SelectValue placeholder="请选择部门" />
    </SelectTrigger>
    <SelectContent>
      {getSortedDepartments().map(dept => (
        <SelectItem key={dept.id} value={dept.id}>
          {dept.name}
        </SelectItem>
      ))}
    </SelectContent>
  </Select>
</div>
```

**优势对比**：

| 特性 | Badge多选 | Select单选 |
|------|----------|-----------|
| 占用空间 | 大（所有部门平铺） | 小（下拉展开） |
| 查找效率 | 低（需要浏览所有选项） | 高（支持键盘搜索） |
| 操作复杂度 | 高（需要点击多次） | 低（一次选择） |
| 视觉清晰度 | 低（选项过多时混乱） | 高（清晰的下拉列表） |
| 移动端友好 | 差（触摸目标小） | 好（原生下拉体验） |

**Select组件的内置功能**：
- ✅ **键盘搜索**：输入部门名称首字母快速定位
- ✅ **滚动支持**：选项过多时自动滚动
- ✅ **无障碍支持**：完整的ARIA标签
- ✅ **原生体验**：移动端使用原生选择器

---

### 4. 响应式布局优化

#### 图表和表格并排显示

```typescript
return (
  <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
    {/* 折线图 */}
    <div className="space-y-4">
      <h4 className="font-semibold text-lg">趋势图表</h4>
      <div className="h-96">
        {/* 图表内容 */}
      </div>
    </div>

    {/* 数据表格 */}
    <div className="space-y-4">
      <h4 className="font-semibold text-lg">数据列表</h4>
      <div className="border rounded-lg overflow-hidden max-h-96 overflow-y-auto">
        {/* 表格内容 */}
      </div>
    </div>
  </div>
);
```

**布局特性**：

1. **宽屏（≥1024px）**
   - 使用 `lg:grid-cols-2`
   - 图表和表格并排显示
   - 充分利用屏幕空间
   - 便于同时查看图表和数据

2. **窄屏（<1024px）**
   - 使用 `grid-cols-1`
   - 图表在上，表格在下
   - 垂直堆叠布局
   - 适合移动设备浏览

3. **表格滚动**
   - `max-h-96`：最大高度限制
   - `overflow-y-auto`：垂直滚动
   - 避免表格过长影响布局

**视觉效果**：

```
宽屏布局（≥1024px）：
┌─────────────────────────────────────────────────┐
│  ┌──────────────────┐  ┌──────────────────┐    │
│  │   趋势图表       │  │   数据列表       │    │
│  │                  │  │                  │    │
│  │   [折线图]       │  │   [表格]         │    │
│  │                  │  │                  │    │
│  └──────────────────┘  └──────────────────┘    │
└─────────────────────────────────────────────────┘

窄屏布局（<1024px）：
┌─────────────────────────────────────────────────┐
│  ┌──────────────────────────────────────────┐  │
│  │   趋势图表                                │  │
│  │                                          │  │
│  │   [折线图]                               │  │
│  │                                          │  │
│  └──────────────────────────────────────────┘  │
│  ┌──────────────────────────────────────────┐  │
│  │   数据列表                                │  │
│  │                                          │  │
│  │   [表格]                                 │  │
│  │                                          │  │
│  └──────────────────────────────────────────┘  │
└─────────────────────────────────────────────────┘
```

---

### 5. 数据表格优化

#### 表格结构调整

**之前的表格**（多部门对比）：
```typescript
<Table>
  <TableHeader>
    <TableRow>
      <TableHead>日期</TableHead>
      <TableHead>工业和信息化部</TableHead>
      <TableHead>北京市通信管理局</TableHead>
      <TableHead>合计</TableHead>
    </TableRow>
  </TableHeader>
  <TableBody>
    {/* 数据行 */}
  </TableBody>
</Table>
```

**现在的表格**（单部门详情）：
```typescript
<Table>
  <TableHeader>
    <TableRow>
      <TableHead className="font-semibold">通报日期</TableHead>
      <TableHead className="font-semibold text-right">应用数量</TableHead>
    </TableRow>
  </TableHeader>
  <TableBody>
    {applicationTrendData.map((dataPoint, index) => (
      <TableRow key={index}>
        <TableCell className="font-medium">{dataPoint.date}</TableCell>
        <TableCell className="text-right">
          {dataPoint[deptName] || 0}
        </TableCell>
      </TableRow>
    ))}
    <TableRow className="bg-muted/50 font-semibold">
      <TableCell>合计</TableCell>
      <TableCell className="text-right">{totalCount}</TableCell>
    </TableRow>
  </TableBody>
</Table>
```

**主要变化**：

1. **列标题调整**
   - ✅ "日期" → "通报日期"（更明确）
   - ✅ 移除多个部门列
   - ✅ 只保留"应用数量"一列

2. **合计位置**
   - ✅ 从表头右侧移到表格底部
   - ✅ 使用特殊样式突出显示（`bg-muted/50 font-semibold`）
   - ✅ 更符合数据统计习惯

3. **合计逻辑**
   ```typescript
   // 计算总数
   const totalCount = applicationTrendData.reduce((sum, dataPoint) => {
     return sum + (dataPoint[deptName] || 0);
   }, 0);
   ```
   - ✅ 统计该部门所有通报日期的应用总数
   - ✅ 处理空值情况（`|| 0`）

**表格示例**：

| 通报日期 | 应用数量 |
|---------|---------|
| 2025-01-15 | 10 |
| 2025-01-20 | 12 |
| 2025-02-10 | 15 |
| 2025-02-25 | 8 |
| **合计** | **45** |

---

### 6. 图表简化

#### 单条折线图

**之前**（多条折线）：
```typescript
{selectedDeptNames.map((deptName, index) => (
  <Line
    key={deptName}
    type="monotone"
    dataKey={deptName}
    stroke={getChartColor(index)}
    strokeWidth={2}
    dot={{ r: 4 }}
    activeDot={{ r: 6 }}
  />
))}
```

**现在**（单条折线）：
```typescript
<Line
  type="monotone"
  dataKey={deptName}
  stroke="#EF4444"
  strokeWidth={2}
  dot={{ r: 4 }}
  activeDot={{ r: 6 }}
/>
```

**优势**：
- ✅ 视觉更清晰，无需区分多条线
- ✅ 固定使用红色（`#EF4444`），突出重点
- ✅ 减少颜色管理复杂度
- ✅ 图例更简洁

---

## 📊 功能特性总结

### 核心功能

| 功能 | 说明 | 状态 |
|------|------|------|
| 单部门选择 | 下拉选择器，支持键盘搜索 | ✅ 已实现 |
| 部门分级排序 | 国家级在前，省级在后 | ✅ 已实现 |
| 时间维度筛选 | 按年统计或全部数据 | ✅ 已实现 |
| 响应式布局 | 宽屏并排，窄屏堆叠 | ✅ 已实现 |
| 折线图展示 | 单条趋势线 | ✅ 已实现 |
| 数据表格 | 详细数值，底部合计 | ✅ 已实现 |
| 实时更新 | 参数变化自动刷新 | ✅ 已实现 |
| 加载状态 | 骨架屏和加载提示 | ✅ 已实现 |
| 错误处理 | 友好的错误提示 | ✅ 已实现 |
| 空状态处理 | 清晰的空状态提示 | ✅ 已实现 |

### 交互特性

| 特性 | 说明 | 状态 |
|------|------|------|
| 下拉选择器 | Select组件，支持搜索 | ✅ 已实现 |
| 部门排序 | 国家级优先显示 | ✅ 已实现 |
| 维度切换 | 下拉选择，条件显示 | ✅ 已实现 |
| 年份选择 | 最近10年可选 | ✅ 已实现 |
| 图表交互 | 悬停显示详情 | ✅ 已实现 |
| 响应式设计 | 适配不同屏幕尺寸 | ✅ 已实现 |
| 自动更新 | 选择部门后自动加载 | ✅ 已实现 |

### 视觉设计

| 元素 | 设计 | 状态 |
|------|------|------|
| 颜色方案 | 红色主题 | ✅ 已实现 |
| 图表样式 | 平滑曲线，标注数据点 | ✅ 已实现 |
| 表格样式 | 边框圆角，底部合计 | ✅ 已实现 |
| 布局方式 | 响应式网格布局 | ✅ 已实现 |
| 空状态 | 图标+文字引导 | ✅ 已实现 |
| 加载状态 | 骨架屏 | ✅ 已实现 |

---

## 🎯 使用指南

### 基本操作流程

1. **访问页面**
   - 点击导航栏"趋势分析"
   - 页面加载后显示通报排名和趋势分析两个模块

2. **选择部门**
   - 在"监管部门趋势分析"模块中
   - 点击"监管部门"下拉选择器
   - 国家级部门显示在列表前面
   - 可以输入部门名称首字母快速定位
   - 选择一个部门

3. **设置参数**
   - 选择数据维度：按年统计或全部数据
   - 如果选择"按年统计"，再选择具体年份

4. **查看结果**
   - 左侧（宽屏）或上方（窄屏）显示折线图
   - 右侧（宽屏）或下方（窄屏）显示数据表格
   - 鼠标悬停在图表上可查看具体数据点
   - 表格底部显示合计数据

5. **切换分析**
   - 选择不同部门查看其他部门的趋势
   - 切换年份或维度查看不同时间段的数据

### 使用场景

#### 场景1：分析单个部门的年度监管趋势

**操作**：
1. 选择"工业和信息化部"
2. 选择数据维度"按年统计"
3. 选择年份"2025年"

**分析**：
- 查看该部门在2025年的通报频率变化
- 识别高峰期和低谷期
- 分析季节性或周期性规律
- 查看年度通报应用总数

#### 场景2：对比不同部门的历史数据

**操作**：
1. 先选择"工业和信息化部"，查看其全部数据
2. 记录或截图关键数据
3. 再选择"北京市通信管理局"，查看其全部数据
4. 对比两个部门的数据

**分析**：
- 对比国家级与省级部门的监管力度
- 识别不同部门的监管重点时期
- 分析监管趋势的异同

#### 场景3：查看部门的完整监管历史

**操作**：
1. 选择感兴趣的部门
2. 选择数据维度"全部数据"

**分析**：
- 查看该部门从开始到现在的所有通报记录
- 识别长期趋势和变化
- 分析监管政策的演变

---

## 🔍 技术细节

### 数据流转

```
用户选择部门
  ↓
状态更新（selectedTrendDepartment）
  ↓
useEffect 触发
  ↓
调用 loadApplicationTrendData()
  ↓
调用 API getDepartmentApplicationTrend([selectedTrendDepartment])
  ↓
Supabase 查询数据库
  ↓
数据处理和转换
  ↓
返回结构化数据
  ↓
更新 applicationTrendData 状态
  ↓
React 重新渲染
  ↓
Recharts 绘制图表 + 渲染表格
  ↓
用户查看结果
```

### 性能优化

1. **条件查询**
   - 只在选择了部门时才发起API请求
   - 避免不必要的数据库查询

2. **数据缓存**
   - 部门列表只在页面加载时获取一次
   - 减少重复请求

3. **按需渲染**
   - 未选择部门时显示空状态，不渲染图表
   - 减少DOM操作

4. **响应式容器**
   - 使用 ResponsiveContainer 自适应尺寸
   - 避免固定尺寸导致的布局问题

5. **表格滚动**
   - 限制表格最大高度
   - 数据过多时自动滚动，不影响整体布局

### 错误处理

1. **API错误**
   ```typescript
   try {
     const data = await getDepartmentApplicationTrend(...);
     setApplicationTrendData(data);
   } catch (error) {
     console.error('加载趋势数据失败:', error);
     toast.error('加载趋势数据失败');
   }
   ```

2. **空数据处理**
   ```typescript
   if (!data || data.length === 0) {
     console.log('[getDepartmentApplicationTrend] 没有数据，返回空结果');
     return [];
   }
   ```

3. **部门未找到**
   ```typescript
   const selectedDept = allDepartments.find(dept => dept.id === selectedTrendDepartment);
   const deptName = selectedDept?.name || '';
   ```

---

## 📈 数据示例

### API返回数据示例

```json
[
  {
    "date": "2025-01-15",
    "工业和信息化部": 10
  },
  {
    "date": "2025-01-20",
    "工业和信息化部": 12
  },
  {
    "date": "2025-02-10",
    "工业和信息化部": 15
  },
  {
    "date": "2025-02-25",
    "工业和信息化部": 8
  }
]
```

### 图表展示效果

```
应用数量
  ↑
15│                    ●
  │                   /
12│        ●         /
  │       / \       /
10│      /   \     /
  │     /     \   /
 8│    ●       \ /
  │             ●
 5│
  │
 0└─────────────────────────→ 日期
   1/15  1/20  2/10  2/25

  ─── 工业和信息化部
```

### 表格展示效果

| 通报日期 | 应用数量 |
|---------|---------|
| 2025-01-15 | 10 |
| 2025-01-20 | 12 |
| 2025-02-10 | 15 |
| 2025-02-25 | 8 |
| **合计** | **45** |

---

## 🎊 优化总结

### 主要改进

✅ **选择方式优化**
- 从Badge多选改为Select单选
- 支持键盘搜索，提高查找效率
- 减少界面占用空间

✅ **部门排序优化**
- 国家级部门优先显示
- 清晰的层级结构
- 便于快速定位

✅ **布局优化**
- 响应式网格布局
- 宽屏并排，窄屏堆叠
- 充分利用屏幕空间

✅ **表格优化**
- 列标题更明确
- 合计移到底部
- 统计逻辑更清晰

✅ **交互优化**
- 自动更新数据
- 流畅的操作体验
- 友好的空状态提示

### 功能价值

1. **简化操作**
   - 单选模式更符合查看单个部门详情的需求
   - 下拉选择器操作更简单直观
   - 减少用户的认知负担

2. **提升效率**
   - 键盘搜索快速定位部门
   - 部门分级排序便于查找
   - 响应式布局适配各种设备

3. **优化展示**
   - 图表和表格并排显示，便于对比
   - 单条折线更清晰
   - 合计数据一目了然

4. **用户友好**
   - 清晰的操作引导
   - 友好的错误提示
   - 完善的空状态处理

### 使用建议

1. **数据准备**
   - 确保数据库中有足够的历史数据
   - 确保 `application_count` 字段填写正确
   - 定期更新案例数据

2. **分析方法**
   - 先选择感兴趣的部门
   - 根据分析目的选择合适的时间维度
   - 结合图表和表格进行综合分析

3. **性能考虑**
   - 大数据量时优先使用"按年统计"
   - 关注控制台日志排查问题
   - 表格自动滚动，避免页面过长

---

**开发时间**：2025-12-10  
**版本**：v2.0（优化版）  
**状态**：✅ 已完成并验证  
**影响范围**：趋势分析页面  
**依赖**：Recharts 图表库  
**兼容性**：与现有功能完全兼容

## 📝 更新日志

### v2.0 (2025-12-10)
- ✅ 将多选模式改为单选模式
- ✅ 使用Select下拉选择器替代Badge
- ✅ 添加部门分级排序（国家级优先）
- ✅ 实现响应式布局（图表和表格并排/堆叠）
- ✅ 优化表格结构（合计移到底部）
- ✅ 简化图表（单条折线）
- ✅ 提升交互体验（自动更新）

### v1.0 (2025-12-10)
- ✅ 初始版本
- ✅ 多部门对比功能
- ✅ Badge多选器
- ✅ 折线图和表格展示
