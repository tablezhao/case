# 趋势概览统计口径调整说明

## 📋 调整概述

将"趋势概览"模块的统计口径从"通报数量"调整为"通报的应用数量"，更准确地反映每月被通报的不同应用数量趋势。

---

## 🔄 调整内容

### 调整前后对比

| 项目 | 调整前 | 调整后 |
|-----|-------|-------|
| **统计维度** | 通报案例数量 | 被通报的应用数量 |
| **统计逻辑** | 统计每月的案例总数 | 统计每月不同应用的数量 |
| **Y轴标签** | 通报数量 | 应用数量 |
| **Tooltip文字** | 通报数量：X 次 | 应用数量：X 个 |
| **说明文字** | 展示通报数量的月度变化趋势 | 展示每月被通报的应用数量变化趋势 |

### 统计逻辑变化

**调整前**：
```typescript
// 统计每月的案例数量
const monthCounts: Record<string, number> = {};
data.forEach(item => {
  const month = item.report_date.substring(0, 7);
  monthCounts[month] = (monthCounts[month] || 0) + 1;
});
```

**调整后**：
```typescript
// 统计每月不同应用的数量（去重）
const monthAppSets: Record<string, Set<string>> = {};
data.forEach(item => {
  const month = item.report_date.substring(0, 7);
  if (!monthAppSets[month]) {
    monthAppSets[month] = new Set();
  }
  if (item.app_name) {
    monthAppSets[month].add(item.app_name);
  }
});
// 返回每月的应用数量（Set的大小）
return Object.entries(monthAppSets)
  .map(([month, appSet]) => ({ month, count: appSet.size }))
  .sort((a, b) => a.month.localeCompare(b.month));
```

---

## 🔧 技术实现

### 1. 新增 API 函数

**文件**：`src/db/api.ts`

**新增函数**：`getMonthlyAppCountTrend()`

```typescript
// 获取每月被通报的应用数量趋势
export async function getMonthlyAppCountTrend(year?: string) {
  let query = supabase.from('cases').select('report_date, app_name');
  
  if (year) {
    query = query.gte('report_date', `${year}-01-01`).lte('report_date', `${year}-12-31`);
  }

  const { data, error } = await query;
  
  if (error) throw error;
  
  // 按月份分组，统计每月不同的应用数量
  const monthAppSets: Record<string, Set<string>> = {};
  (data || []).forEach(item => {
    const month = item.report_date.substring(0, 7);
    if (!monthAppSets[month]) {
      monthAppSets[month] = new Set();
    }
    if (item.app_name) {
      monthAppSets[month].add(item.app_name);
    }
  });

  return Object.entries(monthAppSets)
    .map(([month, appSet]) => ({ month, count: appSet.size }))
    .sort((a, b) => a.month.localeCompare(b.month));
}
```

**函数特点**：
- 查询 `report_date` 和 `app_name` 字段
- 使用 `Set` 数据结构自动去重
- 统计每月不同应用的数量
- 支持按年份筛选（可选参数）
- 返回格式与原函数一致，便于替换

**原函数保留**：
- `getMonthlyTrend()` 函数保留，用于其他可能的用途
- 不影响现有代码的兼容性

### 2. 更新 HomePage.tsx

**文件**：`src/pages/HomePage.tsx`

**导入新函数**：
```typescript
import {
  // ... 其他导入
  getMonthlyAppCountTrend,  // 新增
  // ... 其他导入
} from '@/db/api';
```

**数据加载**：
```typescript
// 在 loadData 函数中
const monthlyAppCountTrend = await getMonthlyAppCountTrend();
setTrendOverviewData(monthlyAppCountTrend);
```

**说明文字更新**：
```typescript
<TooltipInfo
  content={
    <div className="space-y-2">
      <p className="font-semibold">统计说明</p>
      <p className="text-xs text-muted-foreground">
        展示每月被通报的应用数量变化趋势，帮助您快速把握整体动态
      </p>
    </div>
  }
/>
```

### 3. 更新 TrendOverviewChart 组件

**文件**：`src/components/charts/TrendOverviewChart.tsx`

**Y轴标签更新**：
```typescript
<YAxis
  // ... 其他属性
  label={{ 
    value: '应用数量',  // 从"通报数量"改为"应用数量"
    angle: -90, 
    position: 'insideLeft', 
    style: { fill: 'hsl(var(--muted-foreground))', fontSize: 12 } 
  }}
/>
```

**Tooltip 文字更新**：
```typescript
const CustomTooltip = ({ active, payload }: any) => {
  if (active && payload && payload.length) {
    return (
      <div className="bg-background border border-border rounded-lg shadow-lg px-3 py-2">
        <p className="text-sm font-medium">{formatMonth(payload[0].payload.month)}</p>
        <p className="text-sm text-primary font-semibold">
          应用数量：{payload[0].value} 个  {/* 从"通报数量：X 次"改为"应用数量：X 个" */}
        </p>
      </div>
    );
  }
  return null;
};
```

---

## 📊 数据示例

### 调整前的数据（案例数量）

假设某月有以下案例：
- 2024-12-01：应用A被通报
- 2024-12-05：应用B被通报
- 2024-12-10：应用A再次被通报
- 2024-12-15：应用C被通报

**统计结果**：2024年12月通报数量 = 4 次

### 调整后的数据（应用数量）

同样的案例数据：
- 2024-12-01：应用A被通报
- 2024-12-05：应用B被通报
- 2024-12-10：应用A再次被通报（去重）
- 2024-12-15：应用C被通报

**统计结果**：2024年12月应用数量 = 3 个（A、B、C）

### 数据对比

```json
// 调整前（案例数量）
[
  { "month": "2024-07", "count": 12 },
  { "month": "2024-08", "count": 15 },
  { "month": "2024-09", "count": 18 },
  { "month": "2024-10", "count": 14 },
  { "month": "2024-11", "count": 20 },
  { "month": "2024-12", "count": 16 }
]

// 调整后（应用数量，去重）
[
  { "month": "2024-07", "count": 10 },  // 12个案例涉及10个不同应用
  { "month": "2024-08", "count": 12 },  // 15个案例涉及12个不同应用
  { "month": "2024-09", "count": 14 },  // 18个案例涉及14个不同应用
  { "month": "2024-10", "count": 11 },  // 14个案例涉及11个不同应用
  { "month": "2024-11", "count": 16 },  // 20个案例涉及16个不同应用
  { "month": "2024-12", "count": 13 }   // 16个案例涉及13个不同应用
]
```

---

## 💡 调整意义

### 1. 更准确的统计维度

**问题**：
- 同一个应用可能在同一月被多次通报
- 统计案例数量会重复计算同一应用
- 无法反映真实的应用违规情况

**解决**：
- 统计不同应用的数量（去重）
- 每个应用在每月只计算一次
- 更准确地反映违规应用的数量

### 2. 更有意义的趋势分析

**调整前**：
- 显示每月通报的案例总数
- 可能因为同一应用多次通报而数值偏高
- 难以判断违规应用的实际数量

**调整后**：
- 显示每月被通报的不同应用数量
- 去除重复计算，数值更真实
- 更直观地反映违规应用的规模

### 3. 与其他统计口径一致

**数据概览模块**：
- "涉及应用数"统计的是不同应用的数量
- 与趋势概览的统计口径保持一致
- 便于用户理解和对比

**用户理解**：
- "应用数量"比"通报数量"更直观
- 用户更关心有多少应用被通报
- 而不是通报了多少次

---

## 🎯 使用场景

### 场景1：监管力度分析

**用户需求**：了解每月有多少应用被监管部门通报

**调整前**：
- 看到某月通报了20次
- 不知道涉及多少个应用
- 可能是10个应用被通报2次，也可能是20个应用各被通报1次

**调整后**：
- 直接看到某月有15个应用被通报
- 清晰了解违规应用的数量
- 更准确地评估监管力度

### 场景2：趋势变化分析

**用户需求**：观察违规应用数量的变化趋势

**调整前**：
- 曲线上升可能是因为同一批应用被多次通报
- 曲线下降可能只是通报频次减少，违规应用数量未变
- 难以判断真实的趋势

**调整后**：
- 曲线上升表示违规应用数量增加
- 曲线下降表示违规应用数量减少
- 趋势更真实、更有参考价值

### 场景3：数据对比分析

**用户需求**：对比不同时间段的违规情况

**调整前**：
- 对比案例数量，可能受通报频次影响
- 无法准确对比违规应用的规模

**调整后**：
- 对比应用数量，更客观
- 可以准确判断哪个时间段违规应用更多
- 便于制定针对性的监管策略

---

## 📈 数据解读指南

### 上升趋势

**含义**：
- 每月被通报的不同应用数量增加
- 表示违规应用的规模在扩大
- 可能反映：
  - 监管力度加强，发现更多违规应用
  - 应用市场合规情况恶化
  - 新的违规类型出现

**应对**：
- 关注新增的违规应用
- 分析违规类型的变化
- 加强行业监管和宣传

### 下降趋势

**含义**：
- 每月被通报的不同应用数量减少
- 表示违规应用的规模在缩小
- 可能反映：
  - 应用市场合规情况改善
  - 监管政策效果显现
  - 开发者合规意识提高

**应对**：
- 总结成功经验
- 保持监管力度
- 继续推动行业自律

### 波动趋势

**含义**：
- 应用数量上下波动
- 表示违规情况不稳定
- 可能反映：
  - 季节性因素影响
  - 政策调整的影响
  - 特定事件的影响

**应对**：
- 分析波动原因
- 识别规律性变化
- 制定长期监管策略

### 关键数值

**峰值月份**：
- 违规应用数量最多的月份
- 可能对应重大事件或专项整治
- 需要重点关注和分析

**谷值月份**：
- 违规应用数量最少的月份
- 可能对应监管空窗期或合规高峰期
- 可以总结经验和做法

---

## ✅ 验证结果

### 功能验证

- ✅ API 函数正确统计每月不同应用的数量
- ✅ 数据去重逻辑正确（使用 Set）
- ✅ Y轴标签显示"应用数量"
- ✅ Tooltip 显示"应用数量：X 个"
- ✅ 说明文字准确描述统计口径
- ✅ 时间范围筛选功能正常
- ✅ 图表渲染正常，无错误

### 代码质量

- ✅ TypeScript 类型检查通过
- ✅ ESLint 代码规范检查通过
- ✅ 无编译错误和警告
- ✅ 代码逻辑清晰，注释完整
- ✅ 性能优化到位（使用 Set 去重）

### 用户体验

- ✅ 统计口径更准确
- ✅ 数据更有参考价值
- ✅ 文字说明清晰易懂
- ✅ 与其他模块保持一致
- ✅ 无需用户额外学习

---

## 🔍 技术细节

### Set 数据结构的使用

**为什么使用 Set？**
- Set 自动去重，无需手动判断
- 添加元素的时间复杂度为 O(1)
- 获取大小的时间复杂度为 O(1)
- 代码简洁，性能优秀

**实现示例**：
```typescript
const monthAppSets: Record<string, Set<string>> = {};

// 添加应用到对应月份的 Set
data.forEach(item => {
  const month = item.report_date.substring(0, 7);
  if (!monthAppSets[month]) {
    monthAppSets[month] = new Set();
  }
  if (item.app_name) {
    monthAppSets[month].add(item.app_name);  // 自动去重
  }
});

// 获取每月的应用数量
const result = Object.entries(monthAppSets)
  .map(([month, appSet]) => ({ 
    month, 
    count: appSet.size  // Set 的大小即为不同应用的数量
  }));
```

### 空值处理

**问题**：
- 某些案例可能没有 `app_name` 字段
- 需要过滤掉空值，避免统计错误

**解决**：
```typescript
if (item.app_name) {
  monthAppSets[month].add(item.app_name);
}
```

**效果**：
- 只统计有应用名称的案例
- 避免空值影响统计结果
- 保证数据的准确性

### 性能优化

**时间复杂度**：
- 遍历数据：O(n)
- Set 添加操作：O(1)
- 总体时间复杂度：O(n)

**空间复杂度**：
- 存储月份和应用的映射：O(m * a)
  - m：月份数量
  - a：平均每月的应用数量
- 空间复杂度合理，不会造成内存问题

**优化建议**：
- 数据量较大时，可以考虑在后端进行统计
- 使用数据库的 `COUNT(DISTINCT app_name)` 功能
- 减少前端的计算负担

---

## 📁 相关文件

### 修改文件

- ✅ `src/db/api.ts` - 新增 `getMonthlyAppCountTrend()` 函数
- ✅ `src/pages/HomePage.tsx` - 使用新函数，更新说明文字
- ✅ `src/components/charts/TrendOverviewChart.tsx` - 更新 Y轴标签和 Tooltip

### 文档

- ✅ `趋势概览统计口径调整说明.md` - 本文档

---

## 🔄 后续优化建议

### 1. 后端统计优化

**当前实现**：
- 在前端使用 Set 进行去重统计
- 适合数据量较小的情况

**优化方案**：
- 在后端使用 SQL 进行统计
- 使用 `COUNT(DISTINCT app_name)` 
- 减少数据传输量，提高性能

**SQL 示例**：
```sql
SELECT 
  DATE_TRUNC('month', report_date) as month,
  COUNT(DISTINCT app_name) as count
FROM cases
GROUP BY DATE_TRUNC('month', report_date)
ORDER BY month;
```

### 2. 数据缓存

**问题**：
- 每次访问首页都需要重新计算
- 数据量大时可能影响性能

**解决方案**：
- 在后端缓存统计结果
- 定期更新缓存（如每小时）
- 减少重复计算，提高响应速度

### 3. 更多统计维度

**扩展功能**：
- 按部门统计每月应用数量
- 按平台统计每月应用数量
- 按违规类型统计每月应用数量
- 提供更多维度的趋势分析

### 4. 数据对比功能

**增强功能**：
- 同比对比（与去年同期对比）
- 环比对比（与上月对比）
- 显示增长率或下降率
- 帮助用户更好地理解趋势

---

## ✅ 完成确认

### 调整内容

**1. API 函数** ✅
- ✅ 新增 `getMonthlyAppCountTrend()` 函数
- ✅ 使用 Set 进行应用去重
- ✅ 统计每月不同应用的数量
- ✅ 保留原函数，保持兼容性

**2. 前端页面** ✅
- ✅ 使用新的 API 函数
- ✅ 更新说明文字
- ✅ 保持界面布局不变

**3. 图表组件** ✅
- ✅ 更新 Y轴标签为"应用数量"
- ✅ 更新 Tooltip 文字为"应用数量：X 个"
- ✅ 保持图表样式不变

### 质量保证

- ✅ 所有代码通过 ESLint 检查
- ✅ 无 TypeScript 类型错误
- ✅ 统计逻辑正确，去重有效
- ✅ 性能优化到位
- ✅ 用户体验良好
- ✅ 文档完整详细

### 无需任何修复

**所有调整已完整实现，系统运行正常，无需进行任何修复！**

---

**完成日期**: 2025-12-06  
**验证状态**: ✅ 全部通过  
**结论**: 🎉 趋势概览统计口径调整完成，功能正常运行
