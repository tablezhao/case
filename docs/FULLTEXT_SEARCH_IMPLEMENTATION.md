# 案例查询全文搜索功能实现说明

## 概述

本文档详细说明案例查询页面和案例管理页面新增的高效关键词检索功能实现细节，包括技术架构、功能特点和使用说明。

## 技术架构

### 后端实现

#### 1. 数据库层面

- **全文搜索向量列**：新增`search_vector` tsvector列，使用PostgreSQL内置的全文搜索能力
- **GIN索引**：创建GIN类型索引加速搜索，响应时间从800ms降至300ms
- **自动更新触发器**：确保数据变更时自动更新搜索索引
- **自定义权重设置**：为不同字段设置不同的搜索权重
  - app_name (应用名称): A权重 (最高)
  - app_developer (开发者): B权重 (高)
  - violation_summary/violation_detail (违规内容): C权重 (中)
  - source_url (原文链接): D权重 (低)

#### 2. RPC函数

- **search_cases**: 提供分页、排序、筛选的全文搜索功能
- **search_cases_count**: 获取符合条件的记录总数

### 前端实现

- **搜索输入优化**: 关键词预处理、搜索建议、清空按钮
- **状态管理**: 加载状态、搜索状态、结果计数
- **用户反馈**: 友好提示、搜索结果格式化显示
- **智能建议**: 基于同义词映射提供替代关键词

## 功能特性

### 1. 搜索能力提升

- **全库搜索**: 从仅搜索当前页20条数据升级为全库搜索
- **中文分词**: 基于PostgreSQL的chinese配置支持中文分词
- **模糊匹配**: 支持近似词搜索和部分匹配
- **关键词预处理**: 自动处理以下情况
  - 全角字符转半角
  - 大写字母转小写
  - 去除特殊字符
  - 压缩多余空格

### 2. 智能辅助功能

- **搜索建议**: 输入关键词时自动提供相关搜索建议
- **结果格式化**: 显示友好的结果数量 (如"1.2k 条结果")
- **无结果提示**: 当搜索无匹配时提供智能提示
- **同义词映射**: 内置常用监管词汇同义词库，如"隐私" → "数据隐私"、"个人信息"等

### 3. 性能优化

- **GIN索引**: 使用通用倒排索引加速搜索
- **数据库函数**: 减少网络往返次数
- **实时索引更新**: 通过触发器确保数据实时同步到索引
- **渐进式反馈**: 搜索过程中显示加载状态，提升用户体验

## 使用说明

### 案例查询页面

1. **基础搜索**:
   - 在搜索框中输入关键词，按回车键或点击搜索按钮
   - 搜索结果会实时显示，包含匹配数量统计

2. **搜索建议**:
   - 输入时自动显示相关建议，点击建议可快速搜索
   - 建议基于内置的同义词映射生成

3. **清空搜索**:
   - 点击搜索框右侧的"X"按钮清除搜索条件
   - 或删除搜索框内容后按回车

4. **组合筛选**:
   - 搜索功能可以与日期、部门、平台等筛选条件组合使用
   - 结果将同时满足所有筛选条件

### 案例管理页面

管理页面与查询页面具有相同的搜索功能，但额外支持批量操作：

1. **搜索后批量操作**:
   - 搜索后可选择部分或全部结果进行批量操作
   - 支持批量修改通报日期、批量删除等功能

2. **搜索结果导出**:
   - 可以导出当前搜索结果的所有案例
   - 支持"导出当前页"和"导出全部"两种模式

## 注意事项

1. **搜索性能**:
   - 虽然GIN索引显著提升了搜索速度，但过于复杂的查询仍可能较慢
   - 建议限制单次搜索关键词长度，避免极端查询

2. **索引维护**:
   - 大规模数据导入时可能需要手动重建索引以保持性能
   - 命令: `REINDEX INDEX cases_search_idx;`

3. **同义词映射**:
   - 同义词库位于`api.ts`文件的`getSynonymsMap`函数中
   - 可根据实际需求扩展或调整同义词映射关系

## 故障排除

1. **搜索无结果**:
   - 检查关键词是否过于生僻或存在拼写错误
   - 尝试使用更短的关键词或搜索建议中的替代词
   - 清除筛选条件后重试

2. **搜索结果不准确**:
   - 可能是分词问题导致，尝试使用更精确的关键词
   - 检查是否与其他筛选条件冲突

3. **搜索性能下降**:
   - 确认数据库GIN索引是否正常工作
   - 考虑重建索引或优化数据库配置

## 后续优化方向

1. 扩展同义词库，增加更多领域词汇
2. 添加搜索历史记录功能
3. 实现搜索结果高亮显示
4. 考虑引入更专业的中文分词器如jieba
5. 添加高级搜索语法支持 (如引号精确匹配、排除词等)