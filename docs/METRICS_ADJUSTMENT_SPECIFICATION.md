# 指标定义调整说明文档

## 一、调整概述

本次调整将统计口径从"案例数量"优化为"通报频次"，以更准确地反映监管通报活动的密度和活跃度。

---

## 二、核心概念定义

### 2.1 通报频次的定义

**通报频次**：同一个监管部门在同一天内发布的所有应用通报，整体计为**1次通报频次**。

**计算逻辑**：按 `部门ID + 通报日期` 进行去重统计。

**示例说明**：
```
案例1：工信部 2025-12-01 通报了 App A
案例2：工信部 2025-12-01 通报了 App B
案例3：工信部 2025-12-01 通报了 App C
案例4：工信部 2025-12-02 通报了 App D
案例5：网信办 2025-12-01 通报了 App E

通报频次统计：
- 工信部 2025-12-01：1次（包含3个应用）
- 工信部 2025-12-02：1次（包含1个应用）
- 网信办 2025-12-01：1次（包含1个应用）
总计：3次通报频次
```

---

## 三、指标调整详情

### 3.1 指标名称变更

| 原指标名称 | 新指标名称 | 变更说明 |
|-----------|-----------|---------|
| 本月通报案例 | **本月通报频次** | 统计口径从案例数改为通报频次 |
| 累计通报案例总数 | **累计通报频次** | 统计口径从案例数改为通报频次 |
| 本月涉及应用 | 本月涉及应用 | 保持不变 |
| 累计涉及应用总数 | 累计涉及应用总数 | 保持不变 |

---

### 3.2 指标一：本月通报频次

#### 原定义（已废弃）
- **指标名称**：本月通报案例
- **统计口径**：当月所有案例的数量
- **计算方式**：`COUNT(*) WHERE report_date >= '当月1日' AND report_date < '下月1日'`

#### 新定义（当前使用）
- **指标名称**：本月通报频次
- **统计口径**：当月所有通报活动的次数（按部门+日期去重）
- **计算方式**：`COUNT(DISTINCT(department_id || '_' || report_date)) WHERE report_date >= '当月1日' AND report_date < '下月1日'`
- **显示文案**：
  - 标题：本月通报频次
  - 说明：当月通报活动次数
  - 单位：次

#### 环比计算
- **计算基准**：基于通报频次进行环比计算
- **公式**：
  ```
  变化量 = 本月通报频次 - 上月通报频次
  变化百分比 = (变化量 / 上月通报频次) × 100%
  ```
- **显示格式**：`+2 (0.0%) 较上月`

---

### 3.3 指标二：累计通报频次

#### 原定义（已废弃）
- **指标名称**：累计通报案例总数
- **统计口径**：历史所有案例的数量
- **计算方式**：`COUNT(*)`

#### 新定义（当前使用）
- **指标名称**：累计通报频次
- **统计口径**：历史所有通报活动的次数（按部门+日期去重）
- **计算方式**：`COUNT(DISTINCT(department_id || '_' || report_date))`
- **显示文案**：
  - 标题：累计统计
  - 说明：累计通报频次
  - 单位：次通报

#### 数值关系
```
累计通报频次 = Σ(历史所有月份的本月通报频次)
```

---

## 四、技术实现细节

### 4.1 数据库查询逻辑

#### 累计通报频次
```typescript
// 获取所有案例数据
const { data: allCases } = await supabase
  .from('cases')
  .select('report_date, department_id, app_name');

// 按部门+日期去重统计
const totalReportFrequency = new Set(
  (allCases || []).map(c => `${c.department_id}_${c.report_date}`)
).size;
```

#### 本月通报频次
```typescript
// 获取本月案例
const { data: currentMonthCases } = await supabase
  .from('cases')
  .select('report_date, department_id, app_name')
  .gte('report_date', `${currentMonthStr}-01`)
  .lt('report_date', `${nextMonthStr}-01`);

// 按部门+日期去重统计
const currentMonthFrequency = new Set(
  (currentMonthCases || []).map(c => `${c.department_id}_${c.report_date}`)
).size;
```

#### 上月通报频次（用于环比计算）
```typescript
// 获取上月案例
const { data: lastMonthCases } = await supabase
  .from('cases')
  .select('report_date, department_id, app_name')
  .gte('report_date', `${lastMonthStr}-01`)
  .lt('report_date', `${currentMonthStr}-01`);

// 按部门+日期去重统计
const lastMonthFrequency = new Set(
  (lastMonthCases || []).map(c => `${c.department_id}_${c.report_date}`)
).size;
```

---

### 4.2 去重键生成规则

**去重键格式**：`{department_id}_{report_date}`

**示例**：
- 部门ID：`dept-001`
- 通报日期：`2025-12-01`
- 去重键：`dept-001_2025-12-01`

**特点**：
- 唯一性：确保同一部门同一天只计算一次
- 可读性：便于调试和验证
- 性能：使用Set数据结构，O(1)时间复杂度

---

## 五、数据对比示例

### 5.1 示例数据

假设数据库中有以下案例：

| ID | 通报日期 | 部门 | 应用名称 |
|----|---------|------|---------|
| 1 | 2025-12-01 | 工信部 | 微信 |
| 2 | 2025-12-01 | 工信部 | 抖音 |
| 3 | 2025-12-01 | 工信部 | 淘宝 |
| 4 | 2025-12-02 | 工信部 | 京东 |
| 5 | 2025-12-01 | 网信办 | 快手 |
| 6 | 2025-12-03 | 网信办 | 小红书 |

---

### 5.2 统计结果对比

#### 原统计方式（案例数）
- **本月通报案例**：6个
- **累计通报案例**：6个

#### 新统计方式（通报频次）
- **本月通报频次**：4次
  - 工信部 2025-12-01：1次（包含3个应用）
  - 工信部 2025-12-02：1次（包含1个应用）
  - 网信办 2025-12-01：1次（包含1个应用）
  - 网信办 2025-12-03：1次（包含1个应用）
- **累计通报频次**：4次

---

### 5.3 环比计算示例

假设上月数据：

| 通报日期 | 部门 | 应用数量 |
|---------|------|---------|
| 2025-11-15 | 工信部 | 2个 |
| 2025-11-20 | 网信办 | 1个 |

**上月通报频次**：2次

**环比计算**：
```
变化量 = 4 - 2 = +2次
变化百分比 = (2 / 2) × 100% = +100.0%
显示：+2 (+100.0%) 较上月
```

---

## 六、业务价值分析

### 6.1 调整前的问题

1. **数据膨胀**：一次通报活动中涉及多个应用，导致案例数虚高
2. **活跃度失真**：无法准确反映监管部门的通报活动频率
3. **趋势误导**：案例数增加可能只是单次通报涉及应用数增加，而非通报活动增加

---

### 6.2 调整后的优势

1. **准确反映活跃度**：通报频次直接反映监管部门的通报活动密度
2. **趋势更清晰**：环比变化能准确反映监管力度的增减
3. **数据更合理**：避免单次通报涉及多个应用导致的数据膨胀
4. **决策更科学**：为监管趋势分析提供更准确的数据支撑

---

### 6.3 应用场景

#### 场景一：监管力度评估
- **问题**：本月监管力度是否加强？
- **指标**：本月通报频次环比变化
- **示例**：本月通报频次10次，上月5次，环比+100%，说明监管力度显著加强

#### 场景二：部门活跃度对比
- **问题**：哪个部门通报活动最频繁？
- **指标**：各部门通报频次统计
- **示例**：工信部30次，网信办20次，说明工信部通报活动更频繁

#### 场景三：时间趋势分析
- **问题**：通报活动是否呈现季节性规律？
- **指标**：月度通报频次趋势图
- **示例**：每年3月、9月通报频次较高，可能与专项整治行动相关

---

## 七、前端展示调整

### 7.1 卡片标题和说明

#### 卡片1：本月通报频次
```tsx
<StatsCard
  title="本月通报频次"
  value={stats?.current_month_cases || 0}
  description="当月通报活动次数"
  showTrend={true}
/>
```

**显示效果**：
```
本月通报频次
4
当月通报活动次数
[+2 (+100.0%)] 较上月
```

---

#### 卡片2：累计统计
```tsx
<Card>
  <CardTitle>累计统计</CardTitle>
  <CardContent>
    <div>
      <span>32</span>
      <span>次通报</span>
    </div>
    <p>累计通报频次</p>
  </CardContent>
</Card>
```

**显示效果**：
```
累计统计
32 次通报
累计通报频次

32 个应用
累计涉及应用总数
```

---

### 7.2 单位变更

| 位置 | 原单位 | 新单位 |
|-----|-------|-------|
| 本月通报 | 个案例 | 次 |
| 累计统计 | 个案例 | 次通报 |
| 趋势图表 | 案例数 | 通报频次 |

---

## 八、数据迁移说明

### 8.1 是否需要数据迁移？

**答案：不需要**

**原因**：
1. 统计逻辑变更仅影响计算方式，不影响原始数据结构
2. 原始案例数据保持不变，只是统计时按部门+日期去重
3. 历史数据无需修改，新统计逻辑可直接应用于所有历史数据

---

### 8.2 兼容性说明

- ✅ 向后兼容：新统计逻辑可直接应用于所有历史数据
- ✅ 数据完整性：原始案例数据保持完整，不丢失任何信息
- ✅ 可追溯性：可随时切换回原统计方式（如需要）

---

## 九、测试验证

### 9.1 测试场景

#### 场景1：单部门单日多应用
```
输入：
- 工信部 2025-12-01 通报 App A
- 工信部 2025-12-01 通报 App B
- 工信部 2025-12-01 通报 App C

预期输出：
- 通报频次：1次
- 涉及应用：3个
```

#### 场景2：单部门多日多应用
```
输入：
- 工信部 2025-12-01 通报 App A
- 工信部 2025-12-02 通报 App B

预期输出：
- 通报频次：2次
- 涉及应用：2个
```

#### 场景3：多部门单日多应用
```
输入：
- 工信部 2025-12-01 通报 App A
- 网信办 2025-12-01 通报 App B

预期输出：
- 通报频次：2次
- 涉及应用：2个
```

---

### 9.2 验证方法

#### 方法1：手动验证
1. 查看数据库中的案例数据
2. 按部门+日期分组统计
3. 对比前端显示的通报频次

#### 方法2：SQL验证
```sql
-- 计算通报频次
SELECT COUNT(DISTINCT department_id || '_' || report_date) AS report_frequency
FROM cases;

-- 按月统计通报频次
SELECT 
  DATE_TRUNC('month', report_date) AS month,
  COUNT(DISTINCT department_id || '_' || report_date) AS report_frequency
FROM cases
GROUP BY month
ORDER BY month;
```

---

## 十、常见问题解答

### Q1：为什么要改为通报频次？
**A**：通报频次更准确地反映监管活动的密度和活跃度，避免单次通报涉及多个应用导致的数据膨胀。

### Q2：原来的案例数据会丢失吗？
**A**：不会。原始案例数据保持完整，只是统计方式发生变化。

### Q3：如何理解"同一部门同一天计为1次"？
**A**：监管部门通常在同一天发布一份通报文件，其中可能涉及多个应用。我们将这份通报文件计为1次通报活动。

### Q4：环比计算是否准确？
**A**：是的。环比计算基于通报频次，能准确反映监管活动的增减趋势。

### Q5：如果需要查看案例总数怎么办？
**A**：可以在案例查询页面查看详细的案例列表和总数。首页统计卡片专注于展示通报活动的频率。

### Q6：通报频次和案例数的关系是什么？
**A**：通报频次 ≤ 案例数。一次通报可能涉及多个应用，因此案例数通常大于或等于通报频次。

---

## 十一、后续优化建议

### 11.1 短期优化
1. 在案例详情页添加"通报批次"字段，明确标识同一次通报的所有案例
2. 在趋势图表中同时展示"通报频次"和"涉及应用数"两条曲线
3. 添加"平均每次通报涉及应用数"指标

### 11.2 长期优化
1. 建立通报批次表，将同一次通报的案例关联起来
2. 增加通报文件原文链接，方便用户查看完整通报内容
3. 开发通报活动日历视图，直观展示每天的通报活动

---

## 十二、总结

### 12.1 核心变更
- ✅ 统计口径从"案例数"改为"通报频次"
- ✅ 计算逻辑按"部门+日期"去重
- ✅ 显示文案和单位相应调整

### 12.2 业务价值
- ✅ 更准确反映监管活动密度
- ✅ 更清晰展示监管力度趋势
- ✅ 更科学支撑决策分析

### 12.3 技术实现
- ✅ 使用Set数据结构高效去重
- ✅ 保持原始数据完整性
- ✅ 向后兼容所有历史数据

---

**文档版本**：v1.0  
**更新日期**：2025-12-04  
**维护者**：合规通开发团队
