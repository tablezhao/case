# è¿è§„é—®é¢˜åˆ†æåŠŸèƒ½ - æŠ€æœ¯å®ç°æ–‡æ¡£

## ğŸ“ æ¶æ„è®¾è®¡

### æ•´ä½“æ¶æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    å‰ç«¯å±•ç¤ºå±‚                            â”‚
â”‚  TrendAnalysisPage.tsx (è¿è§„é—®é¢˜Tab)                    â”‚
â”‚  â”œâ”€ è¿è§„ç±»å‹åˆ†å¸ƒç»„ä»¶                                     â”‚
â”‚  â”œâ”€ æ—¶é—´è¶‹åŠ¿åˆ†æç»„ä»¶                                     â”‚
â”‚  â”œâ”€ éƒ¨é—¨å…³è”åˆ†æç»„ä»¶                                     â”‚
â”‚  â””â”€ ä¸¥é‡ç¨‹åº¦åˆ†æç»„ä»¶                                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                           â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    APIæ¥å£å±‚                             â”‚
â”‚  src/db/api.ts                                          â”‚
â”‚  â”œâ”€ getViolationTypeAnalysis()                          â”‚
â”‚  â”œâ”€ getViolationTimeTrend()                             â”‚
â”‚  â”œâ”€ getViolationDepartmentAnalysis()                    â”‚
â”‚  â”œâ”€ getViolationSeverityAnalysis()                      â”‚
â”‚  â”œâ”€ exportViolationAnalysis()                           â”‚
â”‚  â””â”€ extractViolationKeywords() (å†…éƒ¨å‡½æ•°)               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                           â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    æ•°æ®å¤„ç†å±‚                            â”‚
â”‚  â”œâ”€ æ•°æ®æŸ¥è¯¢ï¼ˆSupabaseï¼‰                                â”‚
â”‚  â”œâ”€ å…³é”®è¯æå–ï¼ˆæ­£åˆ™åŒ¹é…ï¼‰                              â”‚
â”‚  â”œâ”€ æ•°æ®èšåˆï¼ˆç»Ÿè®¡è®¡ç®—ï¼‰                                â”‚
â”‚  â””â”€ æ•°æ®æ’åºï¼ˆå¤šç»´åº¦ï¼‰                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                           â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    æ•°æ®å­˜å‚¨å±‚                            â”‚
â”‚  Supabase PostgreSQL                                    â”‚
â”‚  â”œâ”€ cases (æ¡ˆä¾‹è¡¨)                                      â”‚
â”‚  â”œâ”€ regulatory_departments (ç›‘ç®¡éƒ¨é—¨è¡¨)                 â”‚
â”‚  â””â”€ app_platforms (åº”ç”¨å¹³å°è¡¨)                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## ğŸ”§ æ ¸å¿ƒåŠŸèƒ½å®ç°

### 1. å…³é”®è¯æå–ç®—æ³•

#### å‡½æ•°ç­¾å
```typescript
function extractViolationKeywords(violationContent: string): string[]
```

#### å®ç°åŸç†

**æ­¥éª¤1ï¼šæ¨¡å¼åŒ¹é…**
```typescript
const patterns = [
  /è¿è§„(æ”¶é›†|ä½¿ç”¨|å¤„ç†|å…±äº«|ä¼ è¾“).*?(ä¸ªäººä¿¡æ¯|ç”¨æˆ·ä¿¡æ¯|éšç§ä¿¡æ¯)/g,
  /æœª(ç»|ç»è¿‡|ç»ç”¨æˆ·)åŒæ„.*?(æ”¶é›†|ä½¿ç”¨|å¤„ç†|å…±äº«)/g,
  /è¶…èŒƒå›´(æ”¶é›†|ä½¿ç”¨|å¤„ç†)/g,
  // ... å…±20+ä¸ªæ¨¡å¼
];
```

**æ­¥éª¤2ï¼šå…³é”®è¯æ¸…ç†**
```typescript
let keyword = match.trim();
if (keyword.length > 30) {
  keyword = keyword.substring(0, 30) + '...';
}
```

**æ­¥éª¤3ï¼šå»é‡å¤„ç†**
```typescript
if (keyword && !keywords.includes(keyword)) {
  keywords.push(keyword);
}
```

**æ­¥éª¤4ï¼šå¤‡ç”¨ç­–ç•¥**
```typescript
if (keywords.length === 0) {
  const sentences = violationContent.split(/[ã€‚ï¼›;]/);
  // æå–ç¬¬ä¸€å¥è¯ä½œä¸ºå…³é”®è¯
}
```

#### æ€§èƒ½ä¼˜åŒ–

- **æ­£åˆ™é¢„ç¼–è¯‘**ï¼šæ‰€æœ‰æ­£åˆ™è¡¨è¾¾å¼åœ¨å‡½æ•°å¤–éƒ¨å®šä¹‰
- **æ—©æœŸè¿”å›**ï¼šç©ºå€¼æˆ–æ— æ•ˆå†…å®¹ç›´æ¥è¿”å›ç©ºæ•°ç»„
- **é•¿åº¦é™åˆ¶**ï¼šå…³é”®è¯æœ€é•¿30å­—ç¬¦ï¼Œé¿å…å†…å­˜æµªè´¹

### 2. è¿è§„ç±»å‹ç»Ÿè®¡

#### å‡½æ•°ç­¾å
```typescript
export async function getViolationTypeAnalysis(
  departmentIds?: string[],
  startDate?: string,
  endDate?: string
): Promise<Array<{ type: string; count: number }>>
```

#### å®ç°æµç¨‹

```typescript
// 1. æ„å»ºæŸ¥è¯¢
let query = supabase
  .from('cases')
  .select('violation_content, report_date, department_id');

// 2. åº”ç”¨ç­›é€‰æ¡ä»¶
if (departmentIds && departmentIds.length > 0) {
  query = query.in('department_id', departmentIds);
}
if (startDate) query = query.gte('report_date', startDate);
if (endDate) query = query.lte('report_date', endDate);

// 3. æ‰§è¡ŒæŸ¥è¯¢
const { data, error } = await query;

// 4. æå–å…³é”®è¯å¹¶ç»Ÿè®¡
const typeCount: Record<string, number> = {};
(data || []).forEach(item => {
  const keywords = extractViolationKeywords(item.violation_content || '');
  keywords.forEach(keyword => {
    typeCount[keyword] = (typeCount[keyword] || 0) + 1;
  });
});

// 5. è½¬æ¢ä¸ºæ•°ç»„å¹¶æ’åº
return Object.entries(typeCount)
  .map(([type, count]) => ({ type, count }))
  .sort((a, b) => b.count - a.count);
```

#### æ•°æ®ç»“æ„

**è¾“å…¥ï¼š**
```typescript
{
  departmentIds: ['uuid1', 'uuid2'],
  startDate: '2024-01-01',
  endDate: '2024-12-31'
}
```

**è¾“å‡ºï¼š**
```typescript
[
  { type: 'è¿è§„æ”¶é›†ä¸ªäººä¿¡æ¯', count: 156 },
  { type: 'æœªç»åŒæ„ä½¿ç”¨æ•°æ®', count: 89 },
  { type: 'è¶…èŒƒå›´æ”¶é›†', count: 67 },
  // ...
]
```

### 3. æ—¶é—´è¶‹åŠ¿åˆ†æ

#### å‡½æ•°ç­¾å
```typescript
export async function getViolationTimeTrend(
  departmentIds: string[] | undefined,
  year: string,
  granularity: 'month' | 'day' = 'month'
): Promise<Array<{ time: string; count: number }>>
```

#### å®ç°é€»è¾‘

```typescript
// 1. æŸ¥è¯¢æŒ‡å®šå¹´ä»½çš„æ•°æ®
let query = supabase
  .from('cases')
  .select('violation_content, report_date')
  .gte('report_date', `${year}-01-01`)
  .lte('report_date', `${year}-12-31`);

// 2. æŒ‰æ—¶é—´ç²’åº¦ç»Ÿè®¡
const timeTrend: Record<string, number> = {};

(data || []).forEach(item => {
  const keywords = extractViolationKeywords(item.violation_content || '');
  if (keywords.length === 0) return;

  let timeKey: string;
  if (granularity === 'month') {
    timeKey = item.report_date.substring(0, 7); // YYYY-MM
  } else {
    timeKey = item.report_date; // YYYY-MM-DD
  }

  timeTrend[timeKey] = (timeTrend[timeKey] || 0) + keywords.length;
});

// 3. è½¬æ¢å¹¶æ’åº
return Object.entries(timeTrend)
  .map(([time, count]) => ({ time, count }))
  .sort((a, b) => a.time.localeCompare(b.time));
```

#### æ—¶é—´ç²’åº¦æ”¯æŒ

| ç²’åº¦ | æ ¼å¼ | ç¤ºä¾‹ |
|------|------|------|
| month | YYYY-MM | 2024-01 |
| day | YYYY-MM-DD | 2024-01-15 |

### 4. éƒ¨é—¨å…³è”åˆ†æ

#### å‡½æ•°ç­¾å
```typescript
export async function getViolationDepartmentAnalysis(
  year: string,
  topN = 10
): Promise<Array<{
  violation: string;
  total: number;
  departments: Array<{
    departmentId: string;
    departmentName: string;
    count: number;
  }>;
}>>
```

#### å®ç°ç®—æ³•

```typescript
// 1. æŸ¥è¯¢æ•°æ®ï¼ˆåŒ…å«éƒ¨é—¨ä¿¡æ¯ï¼‰
const { data, error } = await supabase
  .from('cases')
  .select(`
    violation_content,
    department_id,
    department:regulatory_departments(id, name)
  `)
  .gte('report_date', `${year}-01-01`)
  .lte('report_date', `${year}-12-31`);

// 2. æ„å»ºè¿è§„é—®é¢˜-éƒ¨é—¨æ˜ å°„
const violationDeptMap: Record<string, Record<string, { name: string; count: number }>> = {};

(data || []).forEach(item => {
  const keywords = extractViolationKeywords(item.violation_content || '');
  const deptId = item.department_id;
  const deptName = (item.department as any).name;

  keywords.forEach(keyword => {
    if (!violationDeptMap[keyword]) {
      violationDeptMap[keyword] = {};
    }
    if (!violationDeptMap[keyword][deptId]) {
      violationDeptMap[keyword][deptId] = { name: deptName, count: 0 };
    }
    violationDeptMap[keyword][deptId].count++;
  });
});

// 3. è®¡ç®—æ€»æ•°å¹¶æ’åº
const violationTotals = Object.entries(violationDeptMap).map(([violation, depts]) => {
  const total = Object.values(depts).reduce((sum, dept) => sum + dept.count, 0);
  return { violation, total, departments: depts };
});

violationTotals.sort((a, b) => b.total - a.total);

// 4. è¿”å›TOP N
return violationTotals.slice(0, topN).map(item => ({
  violation: item.violation,
  total: item.total,
  departments: Object.entries(item.departments)
    .map(([id, dept]) => ({
      departmentId: id,
      departmentName: dept.name,
      count: dept.count,
    }))
    .sort((a, b) => b.count - a.count),
}));
```

#### æ•°æ®ç»“æ„ç¤ºä¾‹

```typescript
[
  {
    violation: 'è¿è§„æ”¶é›†ä¸ªäººä¿¡æ¯',
    total: 156,
    departments: [
      { departmentId: 'uuid1', departmentName: 'å·¥ä¿¡éƒ¨', count: 89 },
      { departmentId: 'uuid2', departmentName: 'ç½‘ä¿¡åŠ', count: 45 },
      { departmentId: 'uuid3', departmentName: 'å…¬å®‰éƒ¨', count: 22 },
    ]
  },
  // ...
]
```

### 5. ä¸¥é‡ç¨‹åº¦åˆ†æ

#### å‡½æ•°ç­¾å
```typescript
export async function getViolationSeverityAnalysis(
  year: string
): Promise<{
  high: Array<{ violation: string; count: number }>;
  medium: Array<{ violation: string; count: number }>;
  low: Array<{ violation: string; count: number }>;
}>
```

#### åˆ†çº§ç®—æ³•

```typescript
// 1. ç»Ÿè®¡æ‰€æœ‰è¿è§„é—®é¢˜çš„é¢‘æ¬¡
const violationCount: Record<string, number> = {};
(data || []).forEach(item => {
  const keywords = extractViolationKeywords(item.violation_content || '');
  keywords.forEach(keyword => {
    violationCount[keyword] = (violationCount[keyword] || 0) + 1;
  });
});

// 2. è®¡ç®—åˆ†çº§é˜ˆå€¼
const counts = Object.values(violationCount);
const maxCount = Math.max(...counts);
const highThreshold = maxCount * 0.6;    // 60%
const mediumThreshold = maxCount * 0.3;  // 30%

// 3. åˆ†çº§
const high: Array<{ violation: string; count: number }> = [];
const medium: Array<{ violation: string; count: number }> = [];
const low: Array<{ violation: string; count: number }> = [];

Object.entries(violationCount).forEach(([violation, count]) => {
  const item = { violation, count };
  if (count >= highThreshold) {
    high.push(item);
  } else if (count >= mediumThreshold) {
    medium.push(item);
  } else {
    low.push(item);
  }
});

// 4. æ’åº
high.sort((a, b) => b.count - a.count);
medium.sort((a, b) => b.count - a.count);
low.sort((a, b) => b.count - a.count);

return { high, medium, low };
```

#### åˆ†çº§æ ‡å‡†

| ç­‰çº§ | é˜ˆå€¼ | é¢œè‰² | å«ä¹‰ |
|------|------|------|------|
| é«˜é¢‘ | â‰¥ 60% | çº¢è‰² | ä¸¥é‡ä¸”æ™®é |
| ä¸­é¢‘ | â‰¥ 30% | æ©™è‰² | è¾ƒä¸ºå¸¸è§ |
| ä½é¢‘ | < 30% | ç°è‰² | ç›¸å¯¹å°‘è§ |

### 6. æ•°æ®å¯¼å‡º

#### å‡½æ•°ç­¾å
```typescript
export async function exportViolationAnalysis(
  departmentIds?: string[],
  startDate?: string,
  endDate?: string
): Promise<Array<{
  id: string;
  report_date: string;
  app_name: string;
  app_developer: string;
  department: string;
  platform: string;
  violation_content: string;
  violation_keywords: string;
}>>
```

#### å®ç°æµç¨‹

```typescript
// 1. æŸ¥è¯¢å®Œæ•´æ•°æ®
let query = supabase
  .from('cases')
  .select(`
    id,
    report_date,
    app_name,
    app_developer,
    violation_content,
    department:regulatory_departments(name),
    platform:app_platforms(name)
  `);

// 2. åº”ç”¨ç­›é€‰æ¡ä»¶
// ...

// 3. å¤„ç†æ•°æ®
return (data || []).map(item => ({
  id: item.id,
  report_date: item.report_date,
  app_name: item.app_name,
  app_developer: item.app_developer || 'æœªçŸ¥',
  department: (item.department as any)?.name || 'æœªçŸ¥',
  platform: (item.platform as any)?.name || 'æœªçŸ¥',
  violation_content: item.violation_content || 'æœªæä¾›è¿è§„å†…å®¹',
  violation_keywords: extractViolationKeywords(item.violation_content || '').join('; '),
}));
```

#### CSVç”Ÿæˆ

```typescript
// å‰ç«¯å¤„ç†
const handleExportViolationData = async () => {
  const data = await exportViolationAnalysis(deptIds, startDate, endDate);

  // è½¬æ¢ä¸ºCSV
  const headers = ['é€šæŠ¥æ—¥æœŸ', 'åº”ç”¨åç§°', 'å¼€å‘è€…', 'ç›‘ç®¡éƒ¨é—¨', 'åº”ç”¨å¹³å°', 'è¿è§„å†…å®¹', 'è¿è§„å…³é”®è¯'];
  const csvContent = [
    headers.join(','),
    ...data.map(row => [
      row.report_date,
      `"${row.app_name}"`,
      `"${row.app_developer}"`,
      `"${row.department}"`,
      `"${row.platform}"`,
      `"${row.violation_content.replace(/"/g, '""')}"`,
      `"${row.violation_keywords.replace(/"/g, '""')}"`,
    ].join(','))
  ].join('\n');

  // åˆ›å»ºä¸‹è½½
  const blob = new Blob(['\ufeff' + csvContent], { type: 'text/csv;charset=utf-8;' });
  const link = document.createElement('a');
  link.href = URL.createObjectURL(blob);
  link.download = `è¿è§„é—®é¢˜åˆ†æ_${selectedYear}.csv`;
  link.click();
};
```

## ğŸ¨ å‰ç«¯ç»„ä»¶å®ç°

### çŠ¶æ€ç®¡ç†

```typescript
// è¿è§„é—®é¢˜åˆ†ææ•°æ®çŠ¶æ€
const [violationTypeData, setViolationTypeData] = useState<any[]>([]);
const [violationTrendData, setViolationTrendData] = useState<any[]>([]);
const [violationDeptData, setViolationDeptData] = useState<any[]>([]);
const [violationSeverityData, setViolationSeverityData] = useState<any>(null);
```

### æ•°æ®åŠ è½½

```typescript
const loadAnalysisData = async () => {
  if (activeTab === 'violation') {
    const startDate = `${selectedYear}-01-01`;
    const endDate = `${selectedYear}-12-31`;
    const deptIds = selectedDepartments.length > 0 ? selectedDepartments : undefined;

    const [typeData, trendData, deptData, severityData] = await Promise.all([
      getViolationTypeAnalysis(deptIds, startDate, endDate),
      getViolationTimeTrend(deptIds, selectedYear, 'month'),
      getViolationDepartmentAnalysis(selectedYear, 10),
      getViolationSeverityAnalysis(selectedYear),
    ]);

    setViolationTypeData(typeData);
    setViolationTrendData(trendData);
    setViolationDeptData(deptData);
    setViolationSeverityData(severityData);
  }
};
```

### å¯è§†åŒ–ç»„ä»¶

#### é¥¼å›¾ï¼ˆè¿è§„ç±»å‹åˆ†å¸ƒï¼‰

```typescript
<PieChart>
  <Pie
    data={violationTypeData.slice(0, 15)}
    dataKey="count"
    nameKey="type"
    cx="50%"
    cy="50%"
    outerRadius={120}
    label={(entry) => `${entry.type.substring(0, 15)}${entry.type.length > 15 ? '...' : ''}`}
  >
    {violationTypeData.slice(0, 15).map((_, index) => (
      <Cell key={`cell-${index}`} fill={COLORS[index % COLORS.length]} />
    ))}
  </Pie>
  <Tooltip />
  <Legend />
</PieChart>
```

#### æŠ˜çº¿å›¾ï¼ˆæ—¶é—´è¶‹åŠ¿ï¼‰

```typescript
<LineChart data={violationTrendData}>
  <CartesianGrid strokeDasharray="3 3" />
  <XAxis dataKey="time" />
  <YAxis />
  <Tooltip />
  <Legend />
  <Line
    type="monotone"
    dataKey="count"
    name="è¿è§„é—®é¢˜æ•°é‡"
    stroke="hsl(var(--primary))"
    strokeWidth={2}
    dot={{ r: 4 }}
    activeDot={{ r: 6 }}
  />
</LineChart>
```

## ğŸ” æ€§èƒ½ä¼˜åŒ–

### 1. æ•°æ®åº“æŸ¥è¯¢ä¼˜åŒ–

**ç´¢å¼•ä½¿ç”¨ï¼š**
```sql
-- å·²æœ‰ç´¢å¼•
CREATE INDEX idx_cases_report_date ON cases(report_date DESC);
CREATE INDEX idx_cases_department_id ON cases(department_id);
```

**æŸ¥è¯¢ä¼˜åŒ–ï¼š**
- ä½¿ç”¨ç´¢å¼•å­—æ®µè¿›è¡Œç­›é€‰
- é¿å…å…¨è¡¨æ‰«æ
- åˆç†ä½¿ç”¨JOIN

### 2. å‰ç«¯æ€§èƒ½ä¼˜åŒ–

**å¹¶è¡ŒåŠ è½½ï¼š**
```typescript
const [typeData, trendData, deptData, severityData] = await Promise.all([
  getViolationTypeAnalysis(...),
  getViolationTimeTrend(...),
  getViolationDepartmentAnalysis(...),
  getViolationSeverityAnalysis(...),
]);
```

**æ‡’åŠ è½½ï¼š**
- åªåœ¨åˆ‡æ¢åˆ°è¿è§„é—®é¢˜Tabæ—¶åŠ è½½æ•°æ®
- é¿å…ä¸å¿…è¦çš„æ•°æ®è¯·æ±‚

**æ•°æ®ç¼“å­˜ï¼š**
- ä½¿ç”¨ReactçŠ¶æ€ç¼“å­˜å·²åŠ è½½çš„æ•°æ®
- ç­›é€‰æ¡ä»¶ä¸å˜æ—¶ä¸é‡æ–°åŠ è½½

### 3. ç®—æ³•ä¼˜åŒ–

**å…³é”®è¯æå–ï¼š**
- æ­£åˆ™è¡¨è¾¾å¼é¢„ç¼–è¯‘
- æ—©æœŸè¿”å›é¿å…æ— æ•ˆè®¡ç®—
- é•¿åº¦é™åˆ¶å‡å°‘å†…å­˜å ç”¨

**æ•°æ®èšåˆï¼š**
- ä½¿ç”¨Map/Recordæé«˜æŸ¥æ‰¾æ•ˆç‡
- é¿å…åµŒå¥—å¾ªç¯
- åˆç†ä½¿ç”¨æ•°ç»„æ–¹æ³•

## ğŸ§ª æµ‹è¯•ç­–ç•¥

### å•å…ƒæµ‹è¯•

```typescript
describe('extractViolationKeywords', () => {
  it('åº”è¯¥æå–è¿è§„æ”¶é›†ä¸ªäººä¿¡æ¯', () => {
    const content = 'è¯¥åº”ç”¨è¿è§„æ”¶é›†ç”¨æˆ·ä¸ªäººä¿¡æ¯';
    const keywords = extractViolationKeywords(content);
    expect(keywords).toContain('è¿è§„æ”¶é›†ç”¨æˆ·ä¸ªäººä¿¡æ¯');
  });

  it('åº”è¯¥å¤„ç†ç©ºå†…å®¹', () => {
    const keywords = extractViolationKeywords('');
    expect(keywords).toEqual([]);
  });

  it('åº”è¯¥é™åˆ¶å…³é”®è¯é•¿åº¦', () => {
    const longContent = 'è¿è§„' + 'a'.repeat(100);
    const keywords = extractViolationKeywords(longContent);
    expect(keywords[0].length).toBeLessThanOrEqual(33); // 30 + '...'
  });
});
```

### é›†æˆæµ‹è¯•

```typescript
describe('getViolationTypeAnalysis', () => {
  it('åº”è¯¥è¿”å›æ’åºåçš„è¿è§„ç±»å‹', async () => {
    const result = await getViolationTypeAnalysis();
    expect(result).toBeInstanceOf(Array);
    expect(result[0].count).toBeGreaterThanOrEqual(result[1].count);
  });

  it('åº”è¯¥æ”¯æŒéƒ¨é—¨ç­›é€‰', async () => {
    const result = await getViolationTypeAnalysis(['dept-id']);
    expect(result).toBeInstanceOf(Array);
  });
});
```

### E2Eæµ‹è¯•

```typescript
describe('è¿è§„é—®é¢˜åˆ†æé¡µé¢', () => {
  it('åº”è¯¥æ­£ç¡®åŠ è½½å’Œæ˜¾ç¤ºæ•°æ®', async () => {
    // è®¿é—®é¡µé¢
    await page.goto('/trend-analysis');
    
    // åˆ‡æ¢åˆ°è¿è§„é—®é¢˜Tab
    await page.click('[value="violation"]');
    
    // ç­‰å¾…æ•°æ®åŠ è½½
    await page.waitForSelector('.recharts-pie');
    
    // éªŒè¯å›¾è¡¨å­˜åœ¨
    const chart = await page.$('.recharts-pie');
    expect(chart).toBeTruthy();
  });
});
```

## ğŸ“Š æ•°æ®æµå›¾

```
ç”¨æˆ·æ“ä½œ
   â†“
é€‰æ‹©ç­›é€‰æ¡ä»¶ï¼ˆå¹´ä»½ã€éƒ¨é—¨ï¼‰
   â†“
è§¦å‘ loadAnalysisData()
   â†“
å¹¶è¡Œè°ƒç”¨4ä¸ªAPIå‡½æ•°
   â”œâ”€ getViolationTypeAnalysis()
   â”œâ”€ getViolationTimeTrend()
   â”œâ”€ getViolationDepartmentAnalysis()
   â””â”€ getViolationSeverityAnalysis()
   â†“
æ¯ä¸ªAPIå‡½æ•°æ‰§è¡Œï¼š
   â”œâ”€ æ„å»ºSupabaseæŸ¥è¯¢
   â”œâ”€ åº”ç”¨ç­›é€‰æ¡ä»¶
   â”œâ”€ æ‰§è¡Œæ•°æ®åº“æŸ¥è¯¢
   â”œâ”€ æå–è¿è§„å…³é”®è¯
   â”œâ”€ æ•°æ®èšåˆç»Ÿè®¡
   â””â”€ æ’åºå’Œæ ¼å¼åŒ–
   â†“
æ›´æ–°ReactçŠ¶æ€
   â”œâ”€ setViolationTypeData()
   â”œâ”€ setViolationTrendData()
   â”œâ”€ setViolationDeptData()
   â””â”€ setViolationSeverityData()
   â†“
è§¦å‘ç»„ä»¶é‡æ–°æ¸²æŸ“
   â”œâ”€ é¥¼å›¾æ›´æ–°
   â”œâ”€ æŠ˜çº¿å›¾æ›´æ–°
   â”œâ”€ å¡ç‰‡åˆ—è¡¨æ›´æ–°
   â””â”€ è¡¨æ ¼æ›´æ–°
   â†“
ç”¨æˆ·æŸ¥çœ‹åˆ†æç»“æœ
```

## ğŸ” å®‰å…¨è€ƒè™‘

### 1. SQLæ³¨å…¥é˜²æŠ¤

ä½¿ç”¨Supabaseçš„å‚æ•°åŒ–æŸ¥è¯¢ï¼Œé¿å…SQLæ³¨å…¥ï¼š

```typescript
// âœ… å®‰å…¨
query = query.in('department_id', departmentIds);
query = query.gte('report_date', startDate);

// âŒ ä¸å®‰å…¨ï¼ˆç¤ºä¾‹ï¼Œå®é™…ä»£ç ä¸­ä¸ä½¿ç”¨ï¼‰
// query = query.raw(`WHERE department_id IN (${departmentIds.join(',')})`);
```

### 2. XSSé˜²æŠ¤

Reactè‡ªåŠ¨è½¬ä¹‰è¾“å‡ºï¼Œä½†CSVå¯¼å‡ºéœ€è¦ç‰¹æ®Šå¤„ç†ï¼š

```typescript
// CSVä¸­çš„åŒå¼•å·éœ€è¦è½¬ä¹‰
violation_content.replace(/"/g, '""')
```

### 3. æ•°æ®è®¿é—®æ§åˆ¶

é€šè¿‡Supabase RLSç­–ç•¥æ§åˆ¶æ•°æ®è®¿é—®ï¼š

```sql
-- casesè¡¨çš„RLSç­–ç•¥
CREATE POLICY "Public read access" ON cases
  FOR SELECT USING (true);
```

## ğŸ“ˆ ç›‘æ§ä¸æ—¥å¿—

### é”™è¯¯å¤„ç†

```typescript
try {
  const data = await getViolationTypeAnalysis(...);
  setViolationTypeData(data);
} catch (error) {
  console.error('åŠ è½½åˆ†ææ•°æ®å¤±è´¥:', error);
  toast.error('åŠ è½½åˆ†ææ•°æ®å¤±è´¥');
}
```

### æ€§èƒ½ç›‘æ§

```typescript
const startTime = performance.now();
const data = await getViolationTypeAnalysis(...);
const endTime = performance.now();
console.log(`æŸ¥è¯¢è€—æ—¶: ${endTime - startTime}ms`);
```

## ğŸš€ éƒ¨ç½²æ³¨æ„äº‹é¡¹

### ç¯å¢ƒå˜é‡

```env
VITE_SUPABASE_URL=your-supabase-url
VITE_SUPABASE_ANON_KEY=your-anon-key
```

### æ„å»ºä¼˜åŒ–

```json
{
  "build": {
    "rollupOptions": {
      "output": {
        "manualChunks": {
          "recharts": ["recharts"]
        }
      }
    }
  }
}
```

### æ•°æ®åº“ä¼˜åŒ–

```sql
-- å®šæœŸåˆ†æè¡¨ä»¥ä¼˜åŒ–æŸ¥è¯¢è®¡åˆ’
ANALYZE cases;
ANALYZE regulatory_departments;
```

## ğŸ“š ä¾èµ–åº“

| åº“ | ç‰ˆæœ¬ | ç”¨é€” |
|---|------|------|
| react | ^18.3.1 | UIæ¡†æ¶ |
| recharts | ^2.15.3 | æ•°æ®å¯è§†åŒ– |
| @supabase/supabase-js | ^2.48.1 | æ•°æ®åº“å®¢æˆ·ç«¯ |
| shadcn/ui | latest | UIç»„ä»¶åº“ |
| lucide-react | ^0.553.0 | å›¾æ ‡åº“ |
| sonner | ^1.7.2 | Toasté€šçŸ¥ |

## ğŸ”„ ç‰ˆæœ¬å†å²

### v1.0.0 (2025-12-05)
- âœ¨ åˆå§‹ç‰ˆæœ¬å‘å¸ƒ
- âœ… å®ç°è¿è§„ç±»å‹åˆ†å¸ƒåˆ†æ
- âœ… å®ç°æ—¶é—´è¶‹åŠ¿åˆ†æ
- âœ… å®ç°éƒ¨é—¨å…³è”åˆ†æ
- âœ… å®ç°ä¸¥é‡ç¨‹åº¦åˆ†æ
- âœ… å®ç°æ•°æ®å¯¼å‡ºåŠŸèƒ½
- âœ… æ”¯æŒå¤šç»´åº¦ç­›é€‰

---

**æ–‡æ¡£ç‰ˆæœ¬ï¼š** v1.0  
**æœ€åæ›´æ–°ï¼š** 2025-12-05  
**ç»´æŠ¤å›¢é˜Ÿï¼š** åˆè§„é€šå¼€å‘å›¢é˜Ÿ
