# 更新RPC函数到Supabase的步骤

## 1. 前提条件

- ✅ 已安装Supabase CLI（版本2.65.5+）
- ✅ 已链接Supabase项目（或知道项目的连接信息）
- ✅ 已修改RPC函数的迁移文件

## 2. 部署方法

### 方法1：使用Supabase CLI部署

**步骤**：

1. **检查当前迁移状态**
   ```bash
   npx supabase migration status
   ```

2. **运行迁移命令**
   ```bash
   npx supabase db push
   ```
   - 此命令会将所有未部署的迁移文件（包括修改后的RPC函数）部署到Supabase
   - 会自动检测并部署新的或修改过的迁移文件

3. **验证部署结果**
   ```bash
   npx supabase migration status
   ```
   - 检查迁移文件是否已标记为已部署

### 方法2：使用Supabase Dashboard部署

**步骤**：

1. **登录Supabase Dashboard**
2. **选择项目**
3. **导航到SQL编辑器**
4. **执行修改后的SQL代码**
   ```sql
   -- 创建或替换RPC函数
   CREATE OR REPLACE FUNCTION get_monthly_app_count_trend(time_range TEXT DEFAULT 'all')
   RETURNS TABLE(month TEXT, count INTEGER)
   LANGUAGE plpgsql
   AS $$
   DECLARE
       start_date DATE;
       end_date DATE := CURRENT_DATE;
BEGIN
       -- 根据时间范围计算起始日期
       CASE time_range
           WHEN 'recent6' THEN
               -- 近6个月：包含当前月共6个月
               start_date := date_trunc('month', CURRENT_DATE - INTERVAL '5 months');
           
           WHEN 'thisYear' THEN
               -- 本年至今：从当年1月1日开始
               start_date := date_trunc('year', CURRENT_DATE);
           
           ELSE -- 'all'
               -- 全部数据：从数据集最早日期开始
               SELECT MIN(report_date) INTO start_date FROM cases;
               -- 如果没有数据，设置默认值
               IF start_date IS NULL THEN
                   start_date := date_trunc('year', CURRENT_DATE);
               END IF;
       END CASE;
       
       -- 返回聚合结果
       RETURN QUERY
       SELECT 
           TO_CHAR(date_trunc('month', report_date), 'YYYY-MM') AS month,
           COUNT(DISTINCT app_name)::INTEGER AS count -- 显式转换为INTEGER类型
       FROM cases
       WHERE report_date >= start_date
         AND report_date <= end_date
       GROUP BY date_trunc('month', report_date)
       ORDER BY date_trunc('month', report_date);
   END;
   $$;
   ```
5. **验证部署**
   - 在Dashboard中查看"Database" > "Functions"，确认函数已更新

## 3. 验证部署成功

### 方法1：使用Supabase CLI测试

```bash
# 连接到Supabase数据库
npx supabase db remote connect

# 测试RPC函数
SELECT * FROM get_monthly_app_count_trend('recent6');
```

### 方法2：使用API测试

```bash
# 使用curl测试API
curl -X POST https://your-project.supabase.co/rest/v1/rpc/get_monthly_app_count_trend \
  -H "apikey: your-anon-key" \
  -H "Content-Type: application/json" \
  -d '{"time_range": "recent6"}'
```

### 方法3：通过应用测试

1. 启动应用
2. 访问首页趋势概览模块
3. 切换不同时间范围（近6个月、本年至今、全部）
4. 检查控制台日志，确认RPC调用成功
5. 检查图表数据是否正确显示

## 4. 常见问题及解决方案

### 问题1：Supabase CLI连接失败

**症状**：
```
failed to inspect container health: error during connect: in the default daemon configuration on Windows, the docker client must be run with elevated privileges
```

**解决方案**：
- 确保Docker已运行
- 以管理员身份运行终端
- 或使用Supabase Dashboard部署

### 问题2：迁移文件未识别

**症状**：
```
No pending migrations to apply.
```

**解决方案**：
- 检查迁移文件名称格式是否正确
- 确保迁移文件位于`supabase/migrations/`目录
- 尝试重新创建迁移文件

### 问题3：RPC调用仍失败

**症状**：
```
{code: '42804', details: 'Returned type bigint does not match expected type integer'}
```

**解决方案**：
- 确认迁移已成功部署
- 检查函数定义是否正确
- 重启应用，清除缓存

## 5. 最佳实践

1. **版本控制**：所有迁移文件都应纳入版本控制
2. **测试充分**：在部署前测试RPC函数
3. **监控日志**：添加RPC调用日志，便于调试
4. **定期备份**：部署前备份数据库
5. **文档更新**：更新相关文档，记录RPC函数的修改

## 6. 后续优化建议

1. **添加权限控制**：限制RPC函数的访问权限
2. **优化查询性能**：为`report_date`和`app_name`添加索引
3. **添加错误处理**：在RPC函数中添加更详细的错误处理
4. **实现缓存机制**：减少频繁调用的数据库压力
5. **添加监控**：监控RPC函数的调用频率和响应时间