# 数据不一致问题分析与解决方案

## 1. 问题根源分析 (Root Cause Analysis)

经过对代码架构的深度审查，发现两个模块的数据分别源自两套完全不同的计算逻辑，这是导致数据不一致（10 vs 9）的根本原因：

### 模块 A：首页“本月通报频次” (显示 10)
- **数据源**：`src/db/api.ts` 中的 `getStatsOverview` 函数。
- **计算方式**：**前端计算 (Client-side Calculation)**。
  - 先通过 Supabase 拉取本月所有案例数据 (`currentMonthCases`)。
  - 在 JavaScript 中遍历数组，使用 `new Set()` 对 `${department_id}_${report_date}` 进行去重统计。
- **潜在风险**：
  - **时区偏差**：前端使用浏览器本地时间 (`new Date()`) 计算“本月”的起止时间，可能与服务器 UTC 时间存在偏移。
  - **全量拉取**：随着数据量增加，前端拉取所有明细再计算的方式会导致性能急剧下降。

### 模块 B：趋势页“本月通报风险等级” (显示 9)
- **数据源**：`src/db/api.ts` 中的 `getTrendOverview` 函数。
- **计算方式**：**后端计算 (Server-side Calculation)**。
  - 直接调用数据库存储过程 `rpc('get_trend_overview')`。
  - 所有的统计、去重、时间过滤都在数据库引擎内部完成。
- **优势**：逻辑严谨，性能高，不受客户端环境影响。

**结论**：前端 JS 计算逻辑与后端 SQL 计算逻辑在**时间边界（时区）**或**数据过滤条件**上存在微小差异，导致前端多统计了 1 条数据。

---

## 2. 解决方案 (Solution)

根据 **“第一性原理”** 和 **“极致性能”** 的项目规则，我们不应修补前端的计算逻辑，而应彻底重构，将计算权收归后端。

### 方案：统一使用后端 RPC (Single Source of Truth)

我们将废弃前端的 `getStatsOverview` 手动计算逻辑，改为调用后端 RPC 接口。

#### 步骤 1：创建/复用 RPC 函数
在数据库中确认是否存在能返回首页所需统计数据的 RPC。如果现有的 `get_trend_overview` 数据不够全（首页还需要“涉及应用数”、“环比数据”等），我们需要创建一个新的 RPC `get_dashboard_stats`。

#### 步骤 2：重构前端 API
修改 `src/db/api.ts`，将 `getStatsOverview` 的实现改为直接调用上述 RPC。

#### 步骤 3：前端接入
`HomePage.tsx` 无需修改 UI 逻辑，只需享受底层 API 变更带来的数据一致性和性能提升。

## 3. 实施计划

1.  **后端 (SQL)**: 检查数据库，创建一个聚合查询的 RPC 函数 `get_dashboard_stats`，一次性返回：
    -   本月/本季/本年 通报频次
    -   本月/本季/本年 涉及应用数
    -   相应的环比数据
2.  **前端 (TypeScript)**: 重写 `src/db/api.ts` 中的 `getStatsOverview` 函数。
3.  **验证**: 刷新页面，确认首页和趋势页数据完全一致（均为 9 或均为 10，以数据库为准）。
