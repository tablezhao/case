# 趋势分析页面数据准确性问题修复计划

## 问题定位

1. **问题现象**：[getDepartmentRanking] 查询成功但仅返回1000条记录，导致趋势总览和通报排名模块数据不准确

2. **问题原因**：
   - Supabase默认限制查询结果为1000条记录
   - `getDepartmentRanking`函数直接使用查询返回的原始数据进行统计
   - 当cases表数据量超过1000条时，只统计了部分数据

3. **具体代码位置**：
   - 文件：`src/db/api.ts`
   - 函数：`getDepartmentRanking`（1940行开始）
   - 问题代码：第1999行 `const { data, error } = await query;`

## 解决方案

1. **修改`getDepartmentRanking`函数**：
   - 添加分页逻辑，使用`range`方法获取完整数据集
   - 或者使用`export()`方法导出所有数据
   - 或者使用Supabase的`rpc`函数在服务器端进行统计

2. **修改`getTrendOverview`函数**：
   - 同样添加分页逻辑，确保获取完整数据集

3. **测试验证**：
   - 编写测试用例，模拟超过1000条记录的情况
   - 验证统计结果准确性
   - 确保修复后的数据展示正确

## 实施步骤

1. 退出计划模式
2. 修改`getDepartmentRanking`函数，添加分页逻辑
3. 修改`getTrendOverview`函数，添加分页逻辑
4. 运行TypeScript和ESLint检查
5. 启动开发服务器，验证修复结果
6. 编写测试用例
7. 运行测试，确保修复有效

## 预期效果

- 趋势分析页面数据统计准确，不再受1000条记录限制
- 通报排名模块展示完整的排名数据
- 趋势总览模块展示准确的统计结果
- 测试用例覆盖大数据量场景

## 风险评估

- 大数据量查询可能影响性能，需要考虑优化
- 分页逻辑可能增加代码复杂度
- 可能需要调整前端数据处理逻辑

## 回滚方案

- 恢复修改前的代码
- 重新部署应用

## 实施时间

- 预计修复时间：30分钟
- 预计测试时间：30分钟
- 预计总时间：1小时