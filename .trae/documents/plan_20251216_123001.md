# Favicon管理功能实现计划

## 一、数据结构扩展

### 1. 扩展SiteSettings接口

在`src/types/types.ts`中添加`favicon_url`字段：

```typescript
export interface SiteSettings {
  id: string;
  site_title: string;
  site_subtitle: string | null;
  browser_title: string | null;
  logo_url: string | null;
  favicon_url: string | null; // 新增favicon字段
  created_at: string;
  updated_at: string;
}
```

### 2. 数据库迁移

需要确保数据库`site_settings`表中存在`favicon_url`列（如果不存在，需要创建迁移文件）。

## 二、页面组件实现

### 1. 添加状态管理

在`SiteSettingsPage.tsx`中添加favicon相关状态：

```typescript
const [faviconUrl, setFaviconUrl] = useState<string | null>(null);
const [faviconFile, setFaviconFile] = useState<File | null>(null);
const [faviconPreview, setFaviconPreview] = useState<string | null>(null);
const [faviconUrlInput, setFaviconUrlInput] = useState('');
const [useFaviconUrlInput, setUseFaviconUrlInput] = useState(false);
```

### 2. 加载和保存逻辑

- 在`loadSettings`函数中添加favicon数据加载
- 在`handleSave`函数中添加favicon数据保存

### 3. 上传功能实现

复用现有的logo上传逻辑，针对favicon做以下调整：

- 支持.png和.ico格式
- 单个文件不超过2MB
- 建议尺寸提示
- 上传进度提示

### 4. 预览和删除功能

- 添加当前favicon预览区
- 添加删除按钮及确认机制
- 添加错误处理

## 三、核心功能实现

### 1. Favicon上传组件

```typescript
<div className="space-y-4">
  <div>
    <Label className="flex items-center gap-2 mb-2">
      网站Favicon图标
    </Label>
    <p className="text-xs text-muted-foreground mb-4">
      显示在浏览器标签页的图标，支持.png、.ico格式，建议尺寸16×16px、32×32px、48×48px
    </p>
  </div>

  {/* 切换输入方式 */}
  <div className="flex gap-2">
    <Button
      type="button"
      variant={!useFaviconUrlInput ? 'default' : 'outline'}
      size="sm"
      onClick={() => {
        setUseFaviconUrlInput(false);
        setFaviconUrlInput('');
      }}
    >
      <Upload className="w-4 h-4 mr-2" />
      上传文件
    </Button>
    <Button
      type="button"
      variant={useFaviconUrlInput ? 'default' : 'outline'}
      size="sm"
      onClick={() => {
        setUseFaviconUrlInput(true);
        setFaviconFile(null);
        if (faviconFileInputRef.current) {
          faviconFileInputRef.current.value = '';
        }
      }}
    >
      <ImageIcon className="w-4 h-4 mr-2" />
      输入URL
    </Button>
  </div>

  {/* 文件上传模式 */}
  {!useFaviconUrlInput ? (
    <div className="space-y-4">
      {/* 文件上传区域 */}
      <div className="w-32 h-32 border-2 border-dashed border-border rounded-lg flex items-center justify-center bg-muted/30 overflow-hidden cursor-pointer hover:bg-muted/50 transition-colors" onClick={() => faviconFileInputRef.current?.click()}>
        {faviconPreview ? (
          <img src={faviconPreview} alt="Favicon预览" className="w-full h-full object-contain p-2" />
        ) : (
          <div className="text-center">
            <FileIcon className="w-10 h-10 mx-auto text-muted-foreground" />
            <p className="text-sm text-muted-foreground mt-2">点击上传</p>
            <p className="text-xs text-muted-foreground mt-1">支持.png、.ico格式</p>
          </div>
        )}
      </div>
      <input
        ref={faviconFileInputRef}
        type="file"
        accept=".png,.ico"
        className="hidden"
        onChange={handleFaviconFileChange}
      />
      
      {/* 预览和删除 */}
      {faviconPreview && (
        <div className="flex items-center gap-2">
          <Button variant="outline" size="sm" onClick={handleRemoveFavicon}>
            <Trash className="w-4 h-4 mr-2" />
            删除
          </Button>
          <p className="text-xs text-muted-foreground">
            {faviconFile ? `已选择文件: ${faviconFile.name}` : '使用当前Favicon'}
          </p>
        </div>
      )}
    </div>
  ) : (
    /* URL输入模式 */
    <div className="space-y-3">
      <div className="space-y-2">
        <Label htmlFor="favicon-url">Favicon图标URL</Label>
        <Input
          id="favicon-url"
          value={faviconUrlInput}
          onChange={(e) => {
            const newUrl = e.target.value;
            setFaviconUrlInput(newUrl);
            setFaviconPreview(newUrl || null);
          }}
          placeholder="https://example.com/favicon.ico"
          type="url"
        />
        <p className="text-xs text-muted-foreground">
          输入Favicon图标的完整URL地址
        </p>
      </div>
      
      {/* URL预览 */}
      {faviconUrlInput && (
        <div className="w-16 h-16 border border-border rounded-lg flex items-center justify-center bg-muted/30 overflow-hidden">
          <img src={faviconUrlInput} alt="Favicon预览" className="w-full h-full object-contain p-2" />
        </div>
      )}
    </div>
  )}
</div>
```

### 2. 核心函数实现

```typescript
// 文件上传处理
const handleFaviconFileChange = (e: React.ChangeEvent<HTMLInputElement>) => {
  const file = e.target.files?.[0];
  if (!file) return;
  
  // 验证文件类型
  const allowedTypes = ['image/png', 'image/x-icon', 'image/vnd.microsoft.icon'];
  if (!allowedTypes.includes(file.type)) {
    toast.error('文件格式错误', { description: '仅支持.png和.ico格式' });
    return;
  }
  
  // 验证文件大小
  if (file.size > 2 * 1024 * 1024) {
    toast.error('文件过大', { description: '单个文件不超过2MB' });
    return;
  }
  
  // 预览文件
  const reader = new FileReader();
  reader.onload = (e) => {
    setFaviconPreview(e.target?.result as string);
  };
  reader.readAsDataURL(file);
  
  setFaviconFile(file);
};

// 删除Favicon
const handleRemoveFavicon = () => {
  setFaviconFile(null);
  setFaviconPreview(null);
  setFaviconUrl(null);
  if (faviconFileInputRef.current) {
    faviconFileInputRef.current.value = '';
  }
};
```

### 3. 保存逻辑更新

```typescript
// 在handleSave函数中添加favicon处理
let finalFaviconUrl = faviconUrl;

// 如果使用URL输入模式
if (useFaviconUrlInput) {
  const trimmedUrl = faviconUrlInput.trim();
  finalFaviconUrl = trimmedUrl || null;
} 
// 如果上传了新Favicon
else if (faviconFile) {
  try {
    setUploading(true);
    finalFaviconUrl = await uploadLogo(faviconFile); // 复用现有上传函数，或创建专门的上传函数
    toast.success('Favicon上传成功');
  } catch (error: any) {
    toast.error('Favicon上传失败', {
      description: error.message || '存储桶可能未创建，请使用URL输入方式',
    });
    setUploading(false);
    return;
  } finally {
    setUploading(false);
  }
}
// 如果用户清除了Favicon（非URL输入模式）
else if (!useFaviconUrlInput && faviconUrl && !faviconPreview && !faviconFile) {
  try {
    if (!faviconUrl.startsWith('http')) {
      await deleteLogo(faviconUrl); // 复用现有删除函数，或创建专门的删除函数
    }
    finalFaviconUrl = null;
  } catch (error) {
    console.error('删除Favicon失败:', error);
  }
}

// 更新配置
await updateSiteSettings(settings.id, {
  // 其他配置...
  favicon_url: finalFaviconUrl,
});
```

## 四、HTML头部引用

确保在应用的HTML模板中正确引用favicon：

```html
<link rel="icon" href={siteSettings?.favicon_url || '/default-favicon.ico'} type="image/x-icon">
<link rel="icon" href={siteSettings?.favicon_url || '/default-favicon.ico'} type="image/png" sizes="16x16">
<link rel="icon" href={siteSettings?.favicon_url || '/default-favicon.ico'} type="image/png" sizes="32x32">
<link rel="icon" href={siteSettings?.favicon_url || '/default-favicon.ico'} type="image/png" sizes="48x48">
```

## 五、样式和响应式设计

- 保持与现有后台管理系统一致的UI风格
- 确保在不同设备上都能正常显示
- 添加适当的提示和验证信息
- 优化上传和保存的用户体验

## 六、测试和验证

1. 测试文件上传功能：
   - 支持的文件格式（.png, .ico）
   - 文件大小限制（2MB）
   - 上传进度提示

2. 测试预览功能：
   - 当前favicon预览
   - 新上传favicon预览
   - URL输入预览

3. 测试删除功能：
   - 删除确认机制
   - 删除后状态更新

4. 测试保存功能：
   - 配置保存成功
   - 网站前端正确显示

5. 测试错误处理：
   - 无效文件格式
   - 文件过大
   - 上传失败
   - 网络错误

通过以上计划，我将实现一个完整的favicon管理功能模块，符合用户需求和现有系统的设计风格。