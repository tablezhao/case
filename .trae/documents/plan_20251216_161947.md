## 监管部门饼图数据不一致问题分析与排查方案

### 问题现象
- 案例检索功能显示所有案例数据都已正确关联部门信息
- 首页监管部门饼图未能完整显示全部案例对应的监管部门分布
- 即使部门没有关联案例数据的情况已修复，但问题依然存在

### 可能的原因分析

#### 1. 数据处理逻辑问题

**可能原因**：
- 部门ID匹配错误：案例中的`department_id`与`regulatory_departments`表中的`id`不匹配
- 数据关联关系错误：`cases`表和`regulatory_departments`表的关联字段不正确
- 数据统计逻辑错误：统计方法存在缺陷，导致部分案例未被统计

**排查方向**：
- 检查案例数据中的`department_id`字段格式
- 检查`regulatory_departments`表中的`id`字段格式
- 验证数据关联查询的结果

#### 2. 图表生成规则问题

**可能原因**：
- 图例数量限制：超过限制的部门被合并到"其他"类别
- "其他"类别显示问题："其他"类别未被正确显示
- 数据排序问题：部分部门数据被排在后面，未被显示

**排查方向**：
- 检查`PieChart`组件中的图例数量限制设置
- 验证"其他"类别是否被正确生成
- 检查数据排序逻辑

#### 3. 数据筛选条件问题

**可能原因**：
- 日期范围筛选：只统计了特定日期范围内的数据
- 部门级别筛选：只统计了特定级别的部门
- 其他隐含筛选条件：API函数中存在未注意到的筛选条件

**排查方向**：
- 检查API函数中的数据筛选条件
- 验证是否存在日期范围限制
- 检查部门级别筛选逻辑

#### 4. 异步加载问题

**可能原因**：
- 数据加载顺序问题：图表生成时数据还未完全加载
- 缓存问题：使用了过期的缓存数据
- 数据更新不及时：数据更新后未触发图表重新渲染

**排查方向**：
- 检查数据加载顺序
- 验证缓存机制
- 检查数据更新后的重新渲染逻辑

### 系统性排查方案

#### 阶段1：数据验证与检查

**步骤1：验证案例数据完整性**
```sql
-- 检查所有案例是否都有部门ID
SELECT COUNT(*) AS total_cases, COUNT(department_id) AS cases_with_dept
FROM cases;

-- 检查部门ID为空的案例
SELECT * FROM cases WHERE department_id IS NULL;
```

**步骤2：验证部门数据完整性**
```sql
-- 检查部门表数据
SELECT COUNT(*) AS total_depts, COUNT(id) AS depts_with_id
FROM regulatory_departments;

-- 检查部门级别分布
SELECT level, COUNT(*) AS dept_count
FROM regulatory_departments
GROUP BY level;
```

**步骤3：验证数据关联关系**
```sql
-- 检查案例关联的部门是否存在于部门表中
SELECT c.id, c.department_id, rd.name
FROM cases c
LEFT JOIN regulatory_departments rd ON c.department_id = rd.id
WHERE rd.id IS NULL;
```

#### 阶段2：API函数与数据处理逻辑检查

**步骤1：检查API函数的数据处理逻辑**
- 验证`getNationalDepartmentDistribution`和`getProvincialDepartmentDistribution`函数的实现
- 检查部门ID匹配逻辑
- 检查数据统计方法

**步骤2：添加调试日志**
在API函数中添加调试日志，输出关键数据：
```typescript
export async function getNationalDepartmentDistribution() {
  console.log('Starting getNationalDepartmentDistribution...');
  
  // 获取所有国家级部门
  const { data: departments, error: deptError } = await supabase
    .from('regulatory_departments')
    .select('id, name')
    .eq('level', 'national');
  
  console.log('国家级部门数量:', departments?.length);
  console.log('国家级部门列表:', departments?.map(d => d.name));
  
  // 获取所有案例
  const { data: cases, error: casesError } = await supabase
    .from('cases')
    .select('department_id');
  
  console.log('案例总数:', cases?.length);
  
  // 统计每个部门的案例数量
  const deptCounts: Record<string, number> = {};
  
  // 初始化所有国家级部门的计数为0
  (departments || []).forEach(dept => {
    deptCounts[dept.name] = 0;
  });
  
  // 统计每个部门的案例数量
  (cases || []).forEach(c => {
    if (c.department_id) {
      // 查找对应的部门
      const dept = (departments || []).find(d => d.id === c.department_id);
      if (dept) {
        deptCounts[dept.name] = (deptCounts[dept.name] || 0) + 1;
        console.log(`为部门 ${dept.name} 增加计数，当前计数: ${deptCounts[dept.name]}`);
      } else {
        console.log(`未找到对应部门的案例，department_id: ${c.department_id}`);
      }
    } else {
      console.log('找到department_id为空的案例');
    }
  });
  
  // 返回排序后的数据
  const result = Object.entries(deptCounts)
    .map(([name, count]) => ({ name, count }))
    .sort((a, b) => b.count - a.count);
  
  console.log('最终返回的国家级部门数据:', result);
  
  return result;
}
```

#### 阶段3：图表生成与渲染检查

**步骤1：检查`PieChart`组件的实现**
- 验证图例数量限制设置
- 检查"其他"类别生成逻辑
- 确认图表渲染时数据是否完整

**步骤2：添加图表渲染调试**
在`PieChart`组件中添加调试日志：
```typescript
export default function PieChart({ data, title, children, tooltipContent }: PieChartProps) {
  const chartRef = useRef<HTMLDivElement>(null);
  const [containerWidth, setContainerWidth] = useState(0);

  useEffect(() => {
    console.log('PieChart组件收到的数据:', data);
    console.log('数据长度:', data.length);
    
    if (!chartRef.current || !data.length) return;

    // 其他图表生成逻辑...
    
    // 限制显示的图例数量，避免重叠
    const maxLegendItems = isSmallScreen ? 5 : isMediumScreen ? 8 : 10;
    const displayData = data.slice(0, maxLegendItems);
    
    console.log('最大图例数量:', maxLegendItems);
    console.log('显示的数据:', displayData);
    
    // 如果有更多数据，合并为"其他"
    let chartData = displayData;
    if (data.length > maxLegendItems) {
      const othersCount = data.slice(maxLegendItems).reduce((sum, item) => sum + item.count, 0);
      chartData = [
        ...displayData,
        { name: '其他', count: othersCount }
      ];
      console.log('生成"其他"类别，数量:', othersCount);
      console.log('最终图表数据:', chartData);
    }
    
    // 其他图表生成逻辑...
  }, [data, title, containerWidth]);
  
  // 组件返回...
}
```

#### 阶段4：权限控制与数据筛选检查

**步骤1：检查权限控制设置**
- 验证是否存在数据权限控制
- 检查是否有部门数据被过滤

**步骤2：检查数据筛选条件**
- 验证API函数中是否有日期范围限制
- 检查是否有其他隐含的筛选条件

**步骤3：检查异步加载与缓存机制**
- 验证数据加载顺序
- 检查是否有数据缓存
- 验证数据更新后的重新渲染逻辑

### 预期排查结果

通过以上系统性排查，预期可以定位到导致监管部门饼图数据不一致的具体原因：
1. 部门ID匹配错误
2. 图表图例数量限制
3. 数据筛选条件不当
4. 异步加载或缓存问题
5. 其他未预期的问题

根据排查结果，提供针对性的修复方案，确保监管部门饼图能完整显示全部案例对应的监管部门分布。