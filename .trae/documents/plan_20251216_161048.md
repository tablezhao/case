## 监管部门数据缺失问题分析与解决方案

### 问题分析

通过对代码的分析，我发现监管部门分布饼图中缺少部门数据的问题并非由饼图组件的"其他"图例合并导致，而是由于数据获取逻辑存在问题。

### 可能的原因

1. **部门级别配置错误**：缺少的部门在`regulatory_departments`表中的`level`字段可能不是预期的`'national'`或`'provincial'`

2. **案例数据关联问题**：缺少的部门没有关联到任何案例数据，导致统计数量为0

3. **数据关联关系错误**：`cases`表和`regulatory_departments`表的关联关系存在问题

### 解决方案

#### 1. 检查数据库表结构和数据

**步骤1：检查`regulatory_departments`表结构**
```sql
SELECT column_name, data_type FROM information_schema.columns WHERE table_name = 'regulatory_departments';
```

**步骤2：检查缺少的部门数据**
```sql
SELECT * FROM regulatory_departments WHERE name IN (
  '公安部计算机信息系统安全产品质量监督检验中心',
  '工业和信息化部'
);
```

**步骤3：检查部门关联的案例数据**
```sql
SELECT rd.name, COUNT(c.id) as case_count
FROM regulatory_departments rd
LEFT JOIN cases c ON rd.id = c.department_id
WHERE rd.name IN (
  '公安部计算机信息系统安全产品质量监督检验中心',
  '工业和信息化部'
)
GROUP BY rd.name;
```

#### 2. 优化数据获取逻辑

**步骤1：修改API函数，确保正确统计所有部门**
```typescript
export async function getNationalDepartmentDistribution() {
  // 先获取所有国家级部门
  const { data: departments, error: deptError } = await supabase
    .from('regulatory_departments')
    .select('id, name')
    .eq('level', 'national');
  
  if (deptError) throw deptError;
  
  // 然后获取每个部门的案例数量
  const deptCounts: Record<string, number> = {};
  
  // 初始化所有国家级部门的计数为0
  (departments || []).forEach(dept => {
    deptCounts[dept.name] = 0;
  });
  
  // 查询案例数据
  const { data: cases, error: casesError } = await supabase
    .from('cases')
    .select('department_id');
  
  if (casesError) throw casesError;
  
  // 统计每个部门的案例数量
  (cases || []).forEach(c => {
    if (c.department_id) {
      // 需要通过department_id找到对应的部门名称
      // 这里需要优化，可能需要先建立id到name的映射
    }
  });
  
  // 返回排序后的数据
  return Object.entries(deptCounts)
    .map(([name, count]) => ({ name, count }))
    .sort((a, b) => b.count - a.count);
}
```

**步骤2：优化数据关联查询**
```typescript
export async function getNationalDepartmentDistribution() {
  const { data, error } = await supabase
    .from('regulatory_departments')
    .select(`
      name,
      cases:cases(id)
    `)
    .eq('level', 'national');
  
  if (error) throw error;
  
  return (data || [])
    .map(dept => ({
      name: dept.name,
      count: dept.cases.length
    }))
    .sort((a, b) => b.count - a.count);
}
```

#### 3. 验证修复结果

**步骤1：测试API返回的数据**
```typescript
// 在开发环境中测试API
const nationalDeptData = await getNationalDepartmentDistribution();
console.log('国家级部门数据:', nationalDeptData);
```

**步骤2：检查缺少的部门是否出现在返回数据中**

### 预期效果

通过上述修复，确保：
1. 所有国家级和省级部门都能被正确统计
2. 即使部门没有关联的案例数据，也能显示在饼图中（数量为0）
3. 公安部计算机信息系统安全产品质量监督检验中心、工业和信息化部以及其他缺少的部门能够正确显示在饼图中

### 优先级

1. 高优先级：检查数据库表结构和数据，找出缺少部门的具体原因
2. 中优先级：优化数据获取逻辑，确保所有部门都能被正确统计
3. 低优先级：调整饼图组件，确保所有部门都能被清晰显示

通过以上步骤，可以解决监管部门分布饼图中缺少部门数据的问题。