/**
 * 合规性分析规则库
 * 依据《个人信息保护法》及相关监管通报标准建立
 */

// 1. 智能补全映射表：将不完整/模糊描述映射为标准法律表述
export const COMPLIANCE_MAP: Record<string, string> = {
  // --- 收集与使用类 ---
  '超范围收集': '超范围收集个人信息',
  '超范围使用': '超范围使用个人信息',
  '超范围处理': '超范围处理个人信息',
  '违规收集': '违规收集个人信息',
  '违规使用': '违规使用个人信息',
  '违规处理': '违规处理个人信息',
  '未经同意收集': '未经用户同意收集个人信息',
  '未经同意使用': '未经用户同意使用个人信息',
  '未经同意处理': '未经用户同意处理个人信息',
  '未经同意提供': '未经用户同意向他人提供个人信息',
  '未经同意共享': '未经用户同意向第三方共享个人信息',
  '未经同意上传': '未经用户同意上传个人信息',
  
  // --- 权限类 ---
  '强制授权': '强制用户授权非必要权限',
  '强制索取权限': '强制索取非必要权限',
  '频繁申请权限': '频繁申请非必要权限',
  '过度索取权限': '过度索取系统权限',
  '频繁自启动': '频繁自启动或关联启动',
  '私自收集': '私自收集个人信息',
  '私自调用': '私自调用系统权限',
  
  // --- 告知与隐私政策类 ---
  '未明示收集规则': '未明示收集使用个人信息的规则',
  '未公开收集规则': '未公开收集使用个人信息的规则',
  '未提供隐私政策': '未提供隐私政策',
  '隐私政策难以访问': '隐私政策难以访问',
  '隐私政策难以阅读': '隐私政策难以阅读',
  '未完整告知': '未完整告知个人信息处理规则',
  '未真实告知': '未真实告知个人信息处理规则',
  
  // --- 用户权益类 ---
  '未提供注销功能': '未提供账号注销功能',
  '未提供删除功能': '未提供个人信息删除功能',
  '未提供更正功能': '未提供个人信息更正功能',
  '未提供撤回功能': '未提供撤回同意功能',
  '难以注销': '账号注销难',
  '欺骗误导用户': '欺骗误导用户提供个人信息',
  '诱导用户': '诱导用户下载或点击',
  
  // --- 广告与行为类 ---
  '违规推送': '违规推送弹窗信息',
  '弹窗无法关闭': '弹窗信息无法关闭',
  '强制更新': '强制用户更新版本',
  '捆绑安装': '捆绑安装其他软件',
  '静默下载': '静默下载安装软件',
  '恶意扣费': '恶意扣费',
  '自动扣费': '未经同意自动扣费',
  
  // --- SDK类 ---
  '违规SDK': '第三方SDK违规收集个人信息',
  '第三方SDK违规': '第三方SDK违规收集个人信息'
};

// 2. 核心法律要素（用于校验）
// 每一个合规的描述通常应该包含至少一个行为动词和一个对象名词
export const REQUIRED_ELEMENTS = {
  ACTIONS: ['收集', '使用', '处理', '提供', '共享', '公开', '转让', '注销', '删除', '更正', '撤回', '访问', '阅读', '同意', '告知', '明示', '索取', '申请', '调用', '开启', '启动', '下载', '安装', '推送', '弹窗', '扣费', '更新'],
  OBJECTS: ['个人信息', '隐私政策', '规则', '权限', '功能', '账号', '软件', '应用', 'APP', 'SDK', '广告', '弹窗', '版本', '费用', '同意', '授权']
};

/**
 * 标准化违规描述
 * @param keyword 原始关键词
 * @returns 标准化后的关键词
 */
export function normalizeKeyword(keyword: string): string {
  if (!keyword) return '';
  const trimmed = keyword.trim();
  
  // 1. 直接查表补全
  if (COMPLIANCE_MAP[trimmed]) {
    return COMPLIANCE_MAP[trimmed];
  }
  
  // 2. 模糊匹配补全 (处理包含关系)
  // 例如 "APP强制授权" -> 匹配 "强制授权" -> "强制用户授权非必要权限"
  // 但要注意不要过度匹配
  for (const [key, value] of Object.entries(COMPLIANCE_MAP)) {
    if (trimmed.endsWith(key) && trimmed.length < key.length + 4) {
       // 如果原始词是以 key 结尾，且长度差别不大（例如 "存在超范围收集" -> "超范围收集"）
       return value;
    }
  }
  
  return trimmed;
}

/**
 * 校验违规描述的合规性（完整性）
 * @param keyword 关键词
 * @returns 是否通过校验
 */
export function validateKeyword(keyword: string): boolean {
  if (!keyword || keyword.length < 4) return false;
  
  // 检查是否包含至少一个行为
  const hasAction = REQUIRED_ELEMENTS.ACTIONS.some(act => keyword.includes(act));
  // 检查是否包含至少一个对象（或者它本身就是某些特定的短语，如“欺骗误导用户”）
  const hasObject = REQUIRED_ELEMENTS.OBJECTS.some(obj => keyword.includes(obj)) || keyword.includes('用户');
  
  return hasAction && hasObject;
}
